# -*- coding: utf-8 -*-
import logging
import asyncio
import time
import sys
import traceback
from datetime import datetime, timedelta
from telegram import Update, ReplyKeyboardMarkup, KeyboardButton, InputMediaPhoto, InlineKeyboardButton, InlineKeyboardMarkup, ReplyKeyboardRemove
from telegram.ext import (
   Application,
   CommandHandler,
   MessageHandler,
   CallbackQueryHandler,
   filters,
   ConversationHandler,
   ContextTypes,
)
from telegram.request import HTTPXRequest
from telegram.error import TimedOut, NetworkError
import pymongo
from bson import ObjectId
from telegram.helpers import escape_markdown

# –î—ñ–∞–≥–Ω–æ—Å—Ç–∏—á–Ω–∏–π –∫–æ–¥
print("=" * 50)
print("–ó–ê–ü–£–°–ö WEB3 DATING BOT")
print("–í–µ—Ä—Å—ñ—è Python:", sys.version)
print("=" * 50)

# –û–±—Ä–æ–±–Ω–∏–∫ –Ω–µ–ø–µ—Ä–µ—Ö–æ–ø–ª–µ–Ω–∏—Ö –≤–∏–Ω—è—Ç–∫—ñ–≤
def handle_exception(exc_type, exc_value, exc_traceback):
   print("–ö–†–ò–¢–ò–ß–ù–ê –ü–û–ú–ò–õ–ö–ê:")
   traceback.print_exception(exc_type, exc_value, exc_traceback)
   sys.exit(1)

# –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –æ–±—Ä–æ–±–Ω–∏–∫
sys.excepthook = handle_exception

# Configure logging
logging.basicConfig(
   format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
   level=logging.INFO  # –ó–º—ñ–Ω–µ–Ω–æ –∑ DEBUG –Ω–∞ INFO –¥–ª—è –º–µ–Ω—à –¥–µ—Ç–∞–ª—å–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó
)
logger = logging.getLogger(__name__)

# Bot Configuration
TELEGRAM_TOKEN = "7804499616:AAEVIOp53iDe4byovz955E2wIhVZUgOyHMo"
MONGODB_URL = "mongodb+srv://Vlad:manreds7@cluster0.d0qnz.mongodb.net/?retryWrites=true&w=majority&appName=Cluster0"

# States
(GENDER, PURPOSE, NAME, AGE, AGE_RANGE, CITY,
INTERESTS, INSTAGRAM, MAIN_PHOTO, SELFIE_PHOTO, ADDITIONAL_PHOTO,
VIEWING_PROFILES, SETTINGS, MY_PROFILE, CONFIRM_RESTART,
CONFIRM_DELETE, CHANGE_PHOTO, CHANGE_BIO, EDIT_NAME, EDIT_AGE, EDIT_CITY,
EDIT_INTERESTS, EDIT_INSTAGRAM, WALLET_VERIFICATION, WALLET_ADDRESS,
WALLET_SIGNATURE, WALLET_CONFIRMATION) = range(27)  # –î–æ–¥–∞–ª–∏ –Ω–æ–≤–∏–π —Å—Ç–∞–Ω WALLET_CONFIRMATION

###########################################
# Part 1: Solana Integration
###########################################

class PublicKey:
   """Stub for PublicKey class from Solana"""
   def __init__(self, value=None):
       self.value = value

   def __str__(self):
       return f"PublicKey({self.value})"

   @staticmethod
   def find_program_address(seeds, program_id):
       """Simulation of program address finding"""
       return PublicKey(f"simulated_pda_for_{seeds}"), 255

class Client:
   """Stub for Client class from Solana"""
   def __init__(self, url=None):
       self.url = url

   def get_account_info(self, pubkey):
       """Simulation of getting account info"""
       return {"result": {"value": None}}

class SolanaIntegration:
   def __init__(self):
       """Initialization of Solana integration"""
       try:
           # Using devnet for development
           self.client = Client("https://api.devnet.solana.com")
           self.admin_public_key = "DKCejcctpyK4ivM3yQ1E13qSYnrbUej1KoxeYf3jwZQg"  # Your pubkey
           self.enabled = True  # Is integration active
           logger.info("Solana integration initialized with devnet (simulation mode)")
       except Exception as e:
           logger.error(f"Error initializing Solana integration: {e}", exc_info=True)
           self.enabled = False
           logger.info("Solana integration disabled due to initialization error")

   async def verify_wallet_ownership(self, wallet_address, transaction_reference=None, verification_amount=None):
       """Verification of wallet ownership via test transaction"""
       try:
           if not self.enabled:
               logger.info(f"Wallet verification skipped (integration disabled)")
               return True, "Wallet verification successful (integration disabled)"

           # –°–∏–º—É–ª—é—î–º–æ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É —Ç–µ—Å—Ç–æ–≤–æ—ó —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –¥–ª—è —Ö–∞–∫–∞—Ç–æ–Ω—É
           logger.info(f"Simulating wallet verification for: {wallet_address}")

           # –î–æ–¥–∞—î–º–æ –∑–∞—Ç—Ä–∏–º–∫—É –¥–ª—è —ñ–º—ñ—Ç–∞—Ü—ñ—ó –º–µ—Ä–µ–∂–µ–≤–æ–≥–æ –∑–∞–ø–∏—Ç—É
           await asyncio.sleep(0.2)

           # –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Ä—ñ—à–µ–Ω–Ω—è —Ç—É—Ç –±—É–¥–µ –∫–æ–¥ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
           # –ù–∞–ø—Ä–∏–∫–ª–∞–¥:
           # transaction = await self.client.get_transaction(transaction_reference)
           # if transaction and transaction.sender == wallet_address and abs(transaction.amount - verification_amount) < 0.0000001:
           #     return True, "Wallet verification successful"
           # else:
           #     return False, "Transaction verification failed"

           # –î–ª—è —Ö–∞–∫–∞—Ç–æ–Ω—É –ø—Ä–æ—Å—Ç–æ –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ —É—Å–ø—ñ—Ö
           return True, f"Wallet verification successful via test transaction (development mode)"
       except Exception as e:
           logger.error(f"Wallet verification failed: {e}", exc_info=True)
           return False, f"Verification failed: {str(e)}"

   async def send_bonus_tokens(self, recipient_wallet, token_amount=10):
       """Sending bonus tokens to new user (simulation)"""
       try:
           if not self.enabled:
               logger.info(f"Token sending skipped (integration disabled)")
               return True, f"Tokens sent successfully (integration disabled)"

           # Just simulating sending for now
           logger.info(f"Simulating sending {token_amount} tokens to {recipient_wallet}")

           # –î–æ–¥–∞—î–º–æ –∑–∞—Ç—Ä–∏–º–∫—É –¥–ª—è —ñ–º—ñ—Ç–∞—Ü—ñ—ó –º–µ—Ä–µ–∂–µ–≤–æ–≥–æ –∑–∞–ø–∏—Ç—É
           await asyncio.sleep(0.2)

           # Later we'll replace with real token sending
           return True, f"Successfully sent {token_amount} tokens (development mode)"
       except Exception as e:
           logger.error(f"Failed to send bonus tokens: {e}", exc_info=True)
           return False, f"Failed to send tokens: {str(e)}"

###########################################
# Part 2: On-Chain Matches
###########################################

# Configuration
DATING_PROGRAM_ID = "Your_Future_Program_ID"  # Will be replaced after contract deployment

class OnChainMatches:
   def __init__(self, solana_integration):
       """Initialization with existing Solana integration"""
       try:
           self.solana = solana_integration
           self.client = solana_integration.client
           self.enabled = solana_integration.enabled
           logger.info("OnChainMatches initialized successfully")
       except Exception as e:
           logger.error(f"Error initializing OnChainMatches: {e}", exc_info=True)
           self.enabled = False
           self.solana = solana_integration
           self.client = None
           logger.info("OnChainMatches disabled due to initialization error")

   async def record_match_on_chain(self, user1_id, user2_id, user1_wallet=None, user2_wallet=None):
       """Records match on blockchain (simulation)"""
       try:
           if not self.enabled:
               logger.info("On-chain recording skipped (integration disabled)")
               return False, "Blockchain integration is disabled"

           # Sort IDs for consistency
           if user1_id > user2_id:
               user1_id, user2_id = user2_id, user1_id
               if user1_wallet and user2_wallet:
                   user1_wallet, user2_wallet = user2_wallet, user1_wallet

           # Simulating blockchain recording
           logger.info(f"Simulating on-chain match recording for users {user1_id} and {user2_id}")

           # –î–æ–¥–∞—î–º–æ –∑–∞—Ç—Ä–∏–º–∫—É –¥–ª—è —ñ–º—ñ—Ç–∞—Ü—ñ—ó –º–µ—Ä–µ–∂–µ–≤–æ–≥–æ –∑–∞–ø–∏—Ç—É
           await asyncio.sleep(0.3)

           # Generate fake transaction hash
           simulated_tx_hash = f"simu1ated{user1_id}{user2_id}{int(datetime.now().timestamp())}"
           simulated_address = f"match{user1_id}{user2_id}"

           return True, {
               "transaction_hash": simulated_tx_hash,
               "match_address": simulated_address,
               "simulation_mode": True
           }
       except Exception as e:
           logger.error(f"Failed to record match on-chain: {e}", exc_info=True)
           return False, f"Error recording match: {str(e)}"

   async def verify_match_on_chain(self, user1_id, user2_id):
       """Verifies match existence on blockchain (simulation)"""
       try:
           if not self.enabled:
               logger.info("On-chain verification skipped (integration disabled)")
               return False, "Blockchain integration is disabled"

           # Sort IDs for consistency
           if user1_id > user2_id:
               user1_id, user2_id = user2_id, user1_id

           # Simulating blockchain verification
           logger.info(f"Simulating on-chain match verification for users {user1_id} and {user2_id}")

           # –î–æ–¥–∞—î–º–æ –∑–∞—Ç—Ä–∏–º–∫—É –¥–ª—è —ñ–º—ñ—Ç–∞—Ü—ñ—ó –º–µ—Ä–µ–∂–µ–≤–æ–≥–æ –∑–∞–ø–∏—Ç—É
           await asyncio.sleep(0.2)

           return True, {
               "user_id_1": str(user1_id),
               "user_id_2": str(user2_id),
               "timestamp": int(datetime.now().timestamp()),
               "simulation_mode": True
           }
       except Exception as e:
           logger.error(f"Error verifying match on-chain: {e}", exc_info=True)
           return False, f"Error verifying match: {str(e)}"

###########################################
# Part 3: Token System
###########################################

class TokenSystem:
   def __init__(self, db):
       """Initialization of token system"""
       try:
           self.db = db
           self.users = db.users
           logger.info("Token system initialized")
       except Exception as e:
           logger.error(f"Error initializing TokenSystem: {e}", exc_info=True)
           self.db = db
           self.users = db.users if db else None
           logger.info("TokenSystem initialized with potential issues")

   async def add_tokens(self, user_id, amount, reason="admin"):
       """Adding tokens to user balance"""
       try:
           # Check if user exists
           user = self.users.find_one({"user_id": user_id, "active": True})
           if not user:
               logger.warning(f"Cannot add tokens: User {user_id} not found or inactive")
               return False, "User not found or inactive"

           # Get current balance
           current_balance = user.get('token_balance', 0)
           new_balance = current_balance + amount

           # Update balance
           result = self.users.update_one(
               {"user_id": user_id, "active": True},
               {"$set": {
                   "token_balance": new_balance,
                   "last_token_update": datetime.now()
               },
               "$push": {
                   "token_history": {
                       "amount": amount,
                       "reason": reason,
                       "timestamp": datetime.now()
                   }
               }}
           )

           if result.modified_count > 0:
               logger.info(f"Added {amount} tokens to user {user_id}. New balance: {new_balance}")
               return True, new_balance
           else:
               logger.warning(f"No records updated when adding tokens for user {user_id}")
               return False, "Failed to update token balance"

       except Exception as e:
           logger.error(f"Error adding tokens: {e}", exc_info=True)
           return False, f"Error: {str(e)}"

   async def use_tokens(self, user_id, amount, feature):
       """Using tokens for premium features"""
       try:
           # Check if user exists
           user = self.users.find_one({"user_id": user_id, "active": True})
           if not user:
               logger.warning(f"Cannot use tokens: User {user_id} not found or inactive")
               return False, "User not found or inactive"

           # Get current balance
           current_balance = user.get('token_balance', 0)

           # Check if enough tokens
           if current_balance < amount:
               logger.warning(f"Insufficient tokens: User {user_id} has only {current_balance} tokens, needed {amount}")
               return False, f"Insufficient tokens: you have {current_balance}, needed {amount}"

           # Update balance
           new_balance = current_balance - amount
           result = self.users.update_one(
               {"user_id": user_id, "active": True},
               {"$set": {
                   "token_balance": new_balance,
                   "last_token_update": datetime.now()
               },
               "$push": {
                   "token_history": {
                       "amount": -amount,
                       "feature": feature,
                       "timestamp": datetime.now()
                   }
               }}
           )

           if result.modified_count > 0:
               logger.info(f"User {user_id} spent {amount} tokens on {feature}. New balance: {new_balance}")
               return True, new_balance
           else:
               logger.warning(f"No records updated when using tokens for user {user_id}")
               return False, "Failed to update token balance"

       except Exception as e:
           logger.error(f"Error using tokens: {e}", exc_info=True)
           return False, f"Error: {str(e)}"

   async def get_token_balance(self, user_id):
       """Getting user token balance"""
       try:
           user = self.users.find_one({"user_id": user_id, "active": True})
           if not user:
               return 0

           return user.get('token_balance', 0)
       except Exception as e:
           logger.error(f"Error getting token balance: {e}", exc_info=True)
           return 0

###########################################
# Part 4: Update Schema
###########################################

def update_user_schema():
   """Updating user schema to support Web3 features"""
   client = None
   try:
       client = pymongo.MongoClient(MONGODB_URL)
       db = client.dating_bot
       users = db.users

       # New fields for users
       web3_fields = {
           'wallet_address': None,      # Solana wallet address
           'wallet_verified': False,    # Is wallet verified
           'token_balance': 0,          # Token balance
           'received_bonus': False,     # Has received registration bonus
           'token_history': [],         # Token transaction history
           'web3_features_enabled': True  # Are Web3 features enabled
       }

       # Update all active users
       result = users.update_many(
           {"active": True},
           {"$set": web3_fields},
           upsert=False
       )

       logger.info(f"Updated {result.modified_count} active user records with Web3 fields")

       return True, f"Updated {result.modified_count} users"
   except Exception as e:
       logger.error(f"Error updating user schema: {e}", exc_info=True)
       return False, f"Error: {str(e)}"
   finally:
       if client:
           client.close()

def update_match_schema():
   """Updating match schema to support blockchain"""
   client = None
   try:
       client = pymongo.MongoClient(MONGODB_URL)
       db = client.dating_bot
       matches = db.matches

       # New fields for matches
       blockchain_fields = {
           'on_chain': False,           # Is recorded on blockchain
           'transaction_hash': None,    # Transaction hash
           'match_address': None,       # Match account address on blockchain
           'blockchain_timestamp': None  # Blockchain recording timestamp
       }

       # Update all active matches
       result = matches.update_many(
           {"active": True},
           {"$set": blockchain_fields},
           upsert=False
       )

       logger.info(f"Updated {result.modified_count} active match records with blockchain fields")

       return True, f"Updated {result.modified_count} matches"
   except Exception as e:
       logger.error(f"Error updating match schema: {e}", exc_info=True)
       return False, f"Error: {str(e)}"
   finally:
       if client:
           client.close()

###########################################
# Part 5: LikeSystem with Blockchain Integration
###########################################

class LikeSystem:
   def __init__(self, db, bot_instance):
       try:
           self.db = db
           self.likes = db.likes
           self.matches = db.matches
           self.users = db.users
           self.bot = bot_instance
           logger.info("LikeSystem initialized successfully")
       except Exception as e:
           logger.error(f"Error initializing LikeSystem: {e}", exc_info=True)
           self.db = db
           self.likes = db.likes if db else None
           self.matches = db.matches if db else None
           self.users = db.users if db else None
           self.bot = bot_instance
           logger.info("LikeSystem initialized with potential issues")

   async def create_like(self, from_user_id, to_user_id):
       try:
           # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ —ñ—Å–Ω—É—é—á–∏–π –ª–∞–π–∫
           existing_like = self.likes.find_one({
               "from_user": from_user_id,
               "to_user": to_user_id
           })

           if existing_like:
               return True, "–í–∏ –≤–∂–µ –ª–∞–π–∫–Ω—É–ª–∏ —Ü–µ–π –ø—Ä–æ—Ñ—ñ–ª—å ‚ù§Ô∏è"

           # –û—Ç—Ä–∏–º–∞–Ω–Ω—è —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø—Ä–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –¥–ª—è –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó
           from_user = self.users.find_one({"user_id": from_user_id, "active": True})
           to_user = self.users.find_one({"user_id": to_user_id, "active": True})

           if not from_user or not to_user:
               logger.warning(f"Like between inactive profiles: from={from_user_id}, to={to_user_id}")
               return False, "–ù–µ –≤–¥–∞–ª–æ—Å—è –ø–æ—Å—Ç–∞–≤–∏—Ç–∏ –ª–∞–π–∫. –ü—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω–∏–π."

           # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –ª–∞–π–∫—É
           like = {
               "from_user": from_user_id,
               "to_user": to_user_id,
               "created_at": datetime.now()
           }
           like_result = self.likes.insert_one(like)
           logger.info(f"New like created: {like_result.inserted_id}")

           # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ –≤–∑–∞—î–º–Ω–∏–π –ª–∞–π–∫
           mutual_like = self.likes.find_one({
               "from_user": to_user_id,
               "to_user": from_user_id
           })

           if mutual_like:
               # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –Ω–∞ —ñ—Å–Ω—É—é—á–∏–π –∞–∫—Ç–∏–≤–Ω–∏–π –º–∞—Ç—á, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –¥—É–±–ª—ñ–≤
               existing_match = self.matches.find_one({
                   "users": {"$all": [from_user_id, to_user_id]},
                   "active": True
               })

               if not existing_match:
                   # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –º–∞—Ç—á—É
                   match = {
                       "users": [from_user_id, to_user_id],
                       "created_at": datetime.now(),
                       "active": True,
                       "on_chain": False  # –°–ø–æ—á–∞—Ç–∫—É –Ω–µ –∑–∞–ø–∏—Å–∞–Ω–æ –≤ –±–ª–æ–∫—á–µ–π–Ω
                   }
                   match_result = self.matches.insert_one(match)
                   logger.info(f"New match created: {match_result.inserted_id}")

                   # –ó–∞–ø–∏—Å—É—î–º–æ –º–∞—Ç—á —É –±–ª–æ–∫—á–µ–π–Ω, —è–∫—â–æ —î —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è
                   on_chain_result = {"on_chain": False}

                   if hasattr(self.bot, 'onchain_matches') and self.bot.onchain_matches:
                       try:
                           # –û—Ç—Ä–∏–º—É—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –≥–∞–º–∞–Ω—Ü—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤, —è–∫—â–æ –≤–æ–Ω–∏ —î
                           from_wallet = from_user.get('verified_wallet', None)
                           to_wallet = to_user.get('verified_wallet', None)

                           # –ó–∞–ø–∏—Å—É—î–º–æ –º–∞—Ç—á —É –±–ª–æ–∫—á–µ–π–Ω
                           success, result = await self.bot.onchain_matches.record_match_on_chain(
                               from_user_id,
                               to_user_id,
                               from_wallet,
                               to_wallet
                           )

                           if success:
                               # –û–Ω–æ–≤–ª—é—î–º–æ –∑–∞–ø–∏—Å –º–∞—Ç—á—É –≤ MongoDB –∑ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é –ø—Ä–æ –±–ª–æ–∫—á–µ–π–Ω
                               self.matches.update_one(
                                   {"_id": match_result.inserted_id},
                                   {"$set": {
                                       "on_chain": True,
                                       "transaction_hash": result.get("transaction_hash"),
                                       "match_address": result.get("match_address"),
                                       "blockchain_timestamp": datetime.now()
                                   }}
                               )
                               on_chain_result = {"on_chain": True, "details": result}
                               logger.info(f"Match recorded on-chain: {result}")
                       except Exception as e:
                           logger.error(f"Error recording match on-chain: {e}", exc_info=True)

                   # –§–æ—Ä–º—É—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å
                   result_message = "‚ú® –¶–µ –≤–∑–∞—î–º–Ω–∏–π –ª–∞–π–∫! ‚ú®\n–í–∏ –º–æ–∂–µ—Ç–µ –ø–æ—á–∞—Ç–∏ —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è üíï"

                   # –î–æ–¥–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –±–ª–æ–∫—á–µ–π–Ω, —è–∫—â–æ –∑–∞–ø–∏—Å –±—É–≤ —É—Å–ø—ñ—à–Ω–∏–º
                   if on_chain_result.get("on_chain"):
                       tx_hash = on_chain_result.get("details", {}).get("transaction_hash", "")
                       explorer_url = f"https://explorer.solana.com/tx/{tx_hash}?cluster=devnet"
                       result_message = (
                           "‚ú® –¶–µ –≤–∑–∞—î–º–Ω–∏–π –ª–∞–π–∫! ‚ú®\n"
                           "–í–∏ –º–æ–∂–µ—Ç–µ –ø–æ—á–∞—Ç–∏ —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è üíï\n\n"
                           "üîó –í–∞—à –º–∞—Ç—á –∑–∞–ø–∏—Å–∞–Ω–æ –≤ –±–ª–æ–∫—á–µ–π–Ω Solana!"
                       )

                   # –ê—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –∑–∞–ø—É—Å–∫–∞—î–º–æ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
                   # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ True –ø–µ—Ä–µ–¥ –∑–∞–ø—É—Å–∫–æ–º —Å–ø–æ–≤—ñ—â–µ–Ω—å, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –¥—É–±–ª—ñ–≤
                   result = True, result_message

                   # –ó–∞–ø—É—Å–∫–∞—î–º–æ –ø—Ä–æ—Ü–µ—Å —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è
                   asyncio.create_task(self.notify_match(from_user, to_user))
                   asyncio.create_task(self.notify_match(to_user, from_user))

                   return result
               else:
                   # –ú–∞—Ç—á –≤–∂–µ —ñ—Å–Ω—É—î
                   return True, "‚ú® –¶–µ –≤–∑–∞—î–º–Ω–∏–π –ª–∞–π–∫! ‚ú®\n–í–∏ –º–æ–∂–µ—Ç–µ –ø–æ—á–∞—Ç–∏ —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è üíï"

           return True, "–õ–∞–π–∫ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ ‚ù§Ô∏è"
       except Exception as e:
           logger.error(f"Error in create_like: {e}", exc_info=True)
           return False, "–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ –ª–∞–π–∫—É. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑."

   async def notify_match(self, user, matched_user):
       """–í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ –Ω–æ–≤–∏–π –º–∞—Ç—á –∑ –±–ª–æ–∫—á–µ–π–Ω-—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—î—é"""
       max_retries = 3
       retry_count = 0

       while retry_count < max_retries:
           try:
               # –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞, —á–∏ –º–∞—Ç—á –∑–∞–ø–∏—Å–∞–Ω–∏–π —É –±–ª–æ–∫—á–µ–π–Ω
               match_record = self.matches.find_one({
                   "users": {"$all": [user['user_id'], matched_user['user_id']]},
                   "active": True
               })

               # –§–æ—Ä–º—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—å–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç—É
               profile_text = (
                   f"‚ú® –ù–û–í–ò–ô –ú–ê–¢–ß! ‚ú®\n\n"
                   f"–£ –≤–∞—Å –≤–∑–∞—î–º–Ω–∞ —Å–∏–º–ø–∞—Ç—ñ—è –∑:\n"
                   f"üë§ {matched_user['name']}, {matched_user['age']}\n"
                   f"üåÜ {matched_user['city']}\n"
                   f"üìù {matched_user['interests']}"
               )

               # –î–æ–¥–∞–≤–∞–Ω–Ω—è Instagram, —è–∫—â–æ —î
               if 'instagram' in matched_user and matched_user['instagram']:
                   profile_text += f"\n\nüì∏ Instagram: @{matched_user['instagram']}"

               # –î–æ–¥–∞–≤–∞–Ω–Ω—è –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –∫–æ–Ω—Ç–∞–∫—Ç
               username = matched_user.get('username', '')
               if username:
                   profile_text += f"\n\nüîó –ü–æ—á–∞—Ç–∏ —Å–ø—ñ–ª–∫—É–≤–∞–Ω–Ω—è: @{username}"
               else:
                   profile_text += "\n\n‚ö†Ô∏è –¶–µ–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –º–∞—î username –≤ Telegram."
                   profile_text += f"\nID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞: {matched_user['user_id']}"

               # –î–æ–¥–∞—î–º–æ —Å—Ç–∞—Ç—É—Å –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
               if 'selfie_photo' in matched_user:
                   profile_text += "\n\n‚úÖ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏–≤ —Ñ–æ—Ç–æ"
               else:
                   profile_text += "\n\n‚ö†Ô∏è –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏–≤ —Ñ–æ—Ç–æ"

               # –î–æ–¥–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –±–ª–æ–∫—á–µ–π–Ω, —è–∫—â–æ –º–∞—Ç—á –∑–∞–ø–∏—Å–∞–Ω–∏–π
               if match_record and match_record.get("on_chain"):
                   profile_text += "\n\nüîó –¶–µ–π –º–∞—Ç—á –∑–∞–ø–∏—Å–∞–Ω–æ –≤ –±–ª–æ–∫—á–µ–π–Ω Solana!"

               # –°—Ç–≤–æ—Ä—é—î–º–æ –∫–Ω–æ–ø–∫–∏
               keyboard = []

               # –ë–∞–∑–æ–≤–∞ –∫–Ω–æ–ø–∫–∞ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É –ø–∞—Ä
               keyboard.append([InlineKeyboardButton("–ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –º–æ—ó –ø–∞—Ä–∏", callback_data="view_matches")])

               # –î–æ–¥–∞—î–º–æ –∫–Ω–æ–ø–∫—É –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó, —è–∫—â–æ —î —Ö–µ—à
               if match_record and match_record.get("on_chain") and match_record.get("transaction_hash"):
                   tx_hash = match_record["transaction_hash"]
                   explorer_url = f"https://explorer.solana.com/tx/{tx_hash}?cluster=devnet"
                   keyboard.append([InlineKeyboardButton("üîç –ü–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –≤ Solana Explorer", url=explorer_url)])

               reply_markup = InlineKeyboardMarkup(keyboard)

               # –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –∑ –æ—Å–Ω–æ–≤–Ω–æ—é —Ñ–æ—Ç–æ–≥—Ä–∞—Ñ—ñ—î—é –∞–±–æ –≤—ñ–¥–µ–æ
               media_sent = False

               if 'main_photo' in matched_user and matched_user['main_photo']:
                   try:
                       await self.bot.send_photo(
                           chat_id=user['user_id'],
                           photo=matched_user['main_photo'],
                           caption=profile_text,
                           reply_markup=reply_markup
                       )
                       media_sent = True
                   except Exception as e:
                       logger.error(f"Error sending match photo notification: {e}", exc_info=True)

               if not media_sent and 'main_video' in matched_user and matched_user['main_video']:
                   try:
                       await self.bot.send_video(
                           chat_id=user['user_id'],
                           video=matched_user['main_video'],
                           caption=profile_text,
                           reply_markup=reply_markup
                       )
                       media_sent = True
                   except Exception as e:
                       logger.error(f"Error sending match video notification: {e}", exc_info=True)

               if not media_sent:
                   # –Ø–∫—â–æ –Ω–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –º–µ–¥—ñ–∞, –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –ø—Ä–æ—Å—Ç–æ —Ç–µ–∫—Å—Ç
                   await self.bot.send_message(
                       chat_id=user['user_id'],
                       text=profile_text,
                       reply_markup=reply_markup
                   )

               # –Ø–∫—â–æ –¥—ñ–π—à–ª–∏ —Å—é–¥–∏ –±–µ–∑ –ø–æ–º–∏–ª–æ–∫, –∑–Ω–∞—á–∏—Ç—å —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–æ
               logger.info(f"Match notification sent to user {user['user_id']}")
               return True

           except Exception as e:
               retry_count += 1
               logger.error(f"Error in notify_match (attempt {retry_count}): {e}", exc_info=True)
               await asyncio.sleep(1)  # –ß–µ–∫–∞—î–º–æ —Å–µ–∫—É–Ω–¥—É –ø–µ—Ä–µ–¥ –Ω–∞—Å—Ç—É–ø–Ω–æ—é —Å–ø—Ä–æ–±–æ—é

       # –Ø–∫—â–æ –≤—Å—ñ —Å–ø—Ä–æ–±–∏ –Ω–µ –≤–¥–∞–ª–∏—Å—è, —Ä–æ–±–∏–º–æ –æ—Å—Ç–∞–Ω–Ω—é —Å–ø—Ä–æ–±—É –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–µ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è
       try:
           simple_text = f"‚ú® –£ –≤–∞—Å –Ω–æ–≤–∏–π –º–∞—Ç—á –∑ {matched_user.get('name', '–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º')}! ‚ú®\n–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ä–æ–∑–¥—ñ–ª '–ú–æ—ó –ø–∞—Ä–∏'."
           await self.bot.send_message(
               chat_id=user['user_id'],
               text=simple_text
           )
           logger.info(f"Fallback match notification sent to user {user['user_id']}")
           return True
       except Exception as e:
           logger.error(f"Critical error in notify_match fallback: {e}", exc_info=True)
           return False

###########################################
# Part 6: DatingBot with Web3 Integration
###########################################

class DatingBot:
   def __init__(self, token, db_url):
       try:
           self.token = token
           self.client = pymongo.MongoClient(db_url)
           self.db = self.client.dating_bot
           self.users = self.db.users
           self.likes = self.db.likes
           self.matches = self.db.matches
           self.bot = None  # –ë—É–¥–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø—ñ–∑–Ω—ñ—à–µ
           self.like_system = None  # –ë—É–¥–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø—ñ–∑–Ω—ñ—à–µ

           # –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Web3 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤ (–±—É–¥—É—Ç—å –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ –ø—ñ–∑–Ω—ñ—à–µ)
           self.solana = None
           self.onchain_matches = None
           self.token_system = None

           self.client.server_info()
           logger.info("Successfully connected to MongoDB")
       except Exception as e:
           logger.error(f"Failed to connect to MongoDB: {e}", exc_info=True)
           raise

   def set_bot(self, bot):
       """–í—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ –±–æ—Ç–∞ –ø—ñ—Å–ª—è –π–æ–≥–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è"""
       try:
           self.bot = bot
           # –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ LikeSystem –ø–µ—Ä—à–æ—é
           self.like_system = LikeSystem(self.db, bot)

           # –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑—É—î–º–æ Web3 –∫–æ–º–ø–æ–Ω–µ–Ω—Ç–∏
           self.solana = SolanaIntegration()
           self.onchain_matches = OnChainMatches(self.solana)
           self.token_system = TokenSystem(self.db)
           logger.info("Web3 components initialized successfully")
       except Exception as e:
           logger.error(f"Failed to initialize Web3 components: {e}", exc_info=True)
           # –°—Ç–≤–æ—Ä—é—î–º–æ –∑–∞–≥–ª—É—à–∫–∏, —â–æ–± –±–æ—Ç –º—ñ–≥ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –±–µ–∑ Web3
           if not self.solana:
               self.solana = SolanaIntegration()
               self.solana.enabled = False
           if not self.onchain_matches:
               self.onchain_matches = OnChainMatches(self.solana)
               self.onchain_matches.enabled = False
           if not self.token_system:
               self.token_system = TokenSystem(self.db)
           logger.info("Created fallback Web3 components")

   async def start(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–ü–æ—á–∞—Ç–æ–∫ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –∑ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—î—é –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –≥–∞–º–∞–Ω—Ü—è"""
       user_id = update.effective_user.id
       logger.info(f"Start method called by user: {user_id}")

       try:
           # –û—á–∏—â–µ–Ω–Ω—è –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö –¥–∞–Ω–∏—Ö (–≤–∞—à —ñ—Å–Ω—É—é—á–∏–π –∫–æ–¥)
           delete_time = datetime.now()

           self.users.update_many(
               {"user_id": user_id},
               {"$set": {"active": False, "deleted_at": delete_time}}
           )

           deleted_likes_from = self.likes.delete_many({"from_user": user_id})
           deleted_likes_to = self.likes.delete_many({"to_user": user_id})

           updated_matches = self.matches.update_many(
               {"users": {"$in": [user_id]}},
               {"$set": {"active": False, "deleted_at": delete_time}}
           )

           logger.info(f"Auto-reset for user {user_id}: marked inactive profile, "
                      f"deleted {deleted_likes_from.deleted_count + deleted_likes_to.deleted_count} likes, "
                      f"marked inactive {updated_matches.modified_count} matches")

       except Exception as e:
           logger.error(f"Error during auto-reset in start command: {e}", exc_info=True)

       # –û—á–∏—â–∞—î–º–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
       context.user_data.clear()

       # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ username –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–ª—è –º–∞—Ç—á—ñ–≤
       user = update.effective_user
       if user.username:
           context.user_data['username'] = user.username

       # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –∑ Web3 –∞–∫—Ç–∏–≤–Ω–∞
       if hasattr(self, 'solana') and self.solana and self.solana.enabled:
           # –ü—Ä–æ–ø–æ–Ω—É—î–º–æ Web3 —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—é
           keyboard = [
               [InlineKeyboardButton("‚úÖ –ü—ñ–¥–∫–ª—é—á–∏—Ç–∏ –≥–∞–º–∞–Ω–µ—Ü—å Phantom (–±–æ–Ω—É—Å 100 —Ç–æ–∫–µ–Ω—ñ–≤)", callback_data="connect_phantom")],
               [InlineKeyboardButton("‚è≠Ô∏è –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –±–µ–∑ –≥–∞–º–∞–Ω—Ü—è", callback_data="skip_wallet")]
           ]
           reply_markup = InlineKeyboardMarkup(keyboard)

           await update.message.reply_text(
               "üåü *–°–ø–µ—Ü—ñ–∞–ª—å–Ω–∞ –ø—Ä–æ–ø–æ–∑–∏—Ü—ñ—è!* üåü\n\n"
               "–ü—ñ–¥–∫–ª—é—á—ñ—Ç—å —Å–≤—ñ–π –≥–∞–º–∞–Ω–µ—Ü—å Phantom —ñ –æ—Ç—Ä–∏–º–∞–π—Ç–µ –±–æ–Ω—É—Å–Ω—ñ —Ç–æ–∫–µ–Ω–∏!\n"
               "–¶—ñ —Ç–æ–∫–µ–Ω–∏ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –¥–ª—è –ø—Ä–µ–º—ñ—É–º-—Ñ—É–Ω–∫—Ü—ñ–π —É –±–æ—Ç—ñ.\n\n"
               "–©–æ –≤–∏ –æ–±–∏—Ä–∞—î—Ç–µ?",
               reply_markup=reply_markup,
               parse_mode="Markdown"
           )
           return WALLET_VERIFICATION
       else:
           # –Ø–∫—â–æ Web3 —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—è –Ω–µ –∞–∫—Ç–∏–≤–Ω–∞, –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –∑–≤–∏—á–∞–π–Ω–æ—ó —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
           logger.info(f"Skipping wallet verification for user {user_id} - Solana integration disabled")
           return await self.start_registration_after_wallet(update, context)

   async def handle_wallet_callback(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–æ–±–∫–∞ –∫–æ–ª–±–µ–∫—ñ–≤ –¥–ª—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –≥–∞–º–∞–Ω—Ü—è —á–µ—Ä–µ–∑ —Ç–µ—Å—Ç–æ–≤—É —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é"""
       query = update.callback_query
       await query.answer()

       try:
           if query.data == "connect_phantom":
               # –ì–µ–Ω–µ—Ä—É—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω—É —Å—É–º—É –¥–ª—è –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ–π–Ω–æ—ó —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
               user_id = update.effective_user.id
               verification_amount = 0.000001 + (user_id % 1000) / 100000000  # –£–Ω—ñ–∫–∞–ª—å–Ω–∞ —Å—É–º–∞ –¥–ª—è –∫–æ–∂–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
               context.user_data['verification_amount'] = verification_amount

               # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —á–∞—Å–æ–≤—É –º—ñ—Ç–∫—É –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏
               context.user_data['verification_timestamp'] = int(datetime.now().timestamp())

               # –û—Ç—Ä–∏–º—É—î–º–æ –∞–¥—Ä–µ—Å—É –¥–ª—è –ø—Ä–∏–π–æ–º—É —Ç–µ—Å—Ç–æ–≤–æ—ó —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó (–≤ —Ä–µ–∞–ª—å–Ω–æ—Å—Ç—ñ —Ü–µ –±—É–≤ –±–∏ –≥–∞–º–∞–Ω–µ—Ü—å –≤–∞—à–æ–≥–æ —Å–µ—Ä–≤—ñ—Å—É)
               receiver_address = "DKCejcctpyK4ivM3yQ1E13qSYnrbUej1KoxeYf3jwZQg"  # –ê–¥—Ä–µ—Å–∞ –∑ –≤–∞—à–æ–≥–æ –∫–æ–¥—É
               context.user_data['receiver_address'] = receiver_address

               # –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ—ó —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
               await query.message.reply_text(
                   "–î–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–ª–∞—Å–Ω–æ—Å—Ç—ñ –≥–∞–º–∞–Ω—Ü—è:\n\n"
                   "1. –í—ñ–¥–∫—Ä–∏–π—Ç–µ —Å–≤—ñ–π –≥–∞–º–∞–Ω–µ—Ü—å Phantom\n"
                   "2. –ü–µ—Ä–µ–∫–æ–Ω–∞–π—Ç–µ—Å—å, —â–æ –≤–∏ –≤ —Ä–µ–∂–∏–º—ñ Devnet (Testnet Mode)\n"
                   "3. –ù–∞–¥—ñ—à–ª—ñ—Ç—å —Å—é–¥–∏ –≤–∞—à—É –∞–¥—Ä–µ—Å—É –≥–∞–º–∞–Ω—Ü—è"
               )
               return WALLET_ADDRESS
           elif query.data == "skip_wallet":
               await query.message.reply_text(
                   "–í–∏ –≤–∏—Ä—ñ—à–∏–ª–∏ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –±–µ–∑ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –≥–∞–º–∞–Ω—Ü—è.\n"
                   "–í–∏ –∑–∞–≤–∂–¥–∏ –º–æ–∂–µ—Ç–µ –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏ –π–æ–≥–æ –ø—ñ–∑–Ω—ñ—à–µ –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è—Ö."
               )
               # –ó–∞–ø—É—Å–∫–∞—î–º–æ –∑–≤–∏—á–∞–π–Ω—É —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –∑ –≤–∏–±–æ—Ä—É —Å—Ç–∞—Ç—ñ
               return await self.start_registration_after_wallet(update, context)
       except Exception as e:
           logger.error(f"Error in handle_wallet_callback: {e}", exc_info=True)
           # –£ —Ä–∞–∑—ñ –ø–æ–º–∏–ª–∫–∏ –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –∑–≤–∏—á–∞–π–Ω–æ—ó —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
           await query.message.reply_text(
               "–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—ñ –≥–∞–º–∞–Ω—Ü—è. –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ –±–µ–∑ –Ω—å–æ–≥–æ."
           )
           return await self.start_registration_after_wallet(update, context)

   async def handle_wallet_address(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–æ–±–∫–∞ –≤–≤–µ–¥–µ–Ω–æ—ó –∞–¥—Ä–µ—Å–∏ –≥–∞–º–∞–Ω—Ü—è —Ç–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –¥–ª—è —Ç–µ—Å—Ç–æ–≤–æ—ó —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó"""
       try:
           wallet_address = update.message.text.strip()
           context.user_data['wallet_address'] = wallet_address

           # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —á–∏ –º–∞—î –∞–¥—Ä–µ—Å–∞ –ø—Ä–∞–≤–∏–ª—å–Ω–∏–π —Ñ–æ—Ä–º–∞—Ç –¥–ª—è Solana (base58, 32-44 —Å–∏–º–≤–æ–ª–∏)
           if not (len(wallet_address) >= 32 and len(wallet_address) <= 44):
               await update.message.reply_text(
                   "‚ùå –¶–µ –Ω–µ —Å—Ö–æ–∂–µ –Ω–∞ –¥—ñ–π—Å–Ω—É –∞–¥—Ä–µ—Å—É –≥–∞–º–∞–Ω—Ü—è Solana.\n"
                   "–ë—É–¥—å –ª–∞—Å–∫–∞, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ —ñ —Å–ø—Ä–æ–±—É–π—Ç–µ –∑–Ω–æ–≤—É, –∞–±–æ –æ–±–µ—Ä—ñ—Ç—å '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏'."
               )
               keyboard = [
                   [InlineKeyboardButton("‚è≠Ô∏è –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –±–µ–∑ –≥–∞–º–∞–Ω—Ü—è", callback_data="skip_wallet")]
               ]
               reply_markup = InlineKeyboardMarkup(keyboard)
               await update.message.reply_text("–ê–±–æ –ø—Ä–æ–ø—É—Å—Ç—ñ—Ç—å —Ü–µ–π –∫—Ä–æ–∫:", reply_markup=reply_markup)
               return WALLET_ADDRESS

           # –ì–µ–Ω–µ—Ä—É—î–º–æ —É–Ω—ñ–∫–∞–ª—å–Ω—É —Å—É–º—É –¥–ª—è –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó (–º–æ–∂–Ω–∞ –≤–∑—è—Ç–∏ –∑ context.user_data)
           verification_amount = context.user_data.get('verification_amount', 0.000001)
           receiver_address = context.user_data.get('receiver_address', "DKCejcctpyK4ivM3yQ1E13qSYnrbUej1KoxeYf3jwZQg")

           # –ü–æ–≤—ñ–¥–æ–º–ª—è—î–º–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –ø—Ä–æ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ—Å—Ç—å –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Ç–µ—Å—Ç–æ–≤–æ—ó —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
           await update.message.reply_text(
               f"–ê–¥—Ä–µ—Å–∞ –≥–∞–º–∞–Ω—Ü—è –æ—Ç—Ä–∏–º–∞–Ω–∞: `{wallet_address}`\n\n"
               f"–î–ª—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–ª–∞—Å–Ω–æ—Å—Ç—ñ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ –¢–ï–°–¢–û–í–£ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é –Ω–∞ –∞–¥—Ä–µ—Å—É:\n"
               f"`{receiver_address}`\n\n"
               f"–°—É–º–∞: `{verification_amount:.8f}` SOL\n\n"
               f"–ü—ñ—Å–ª—è –≤—ñ–¥–ø—Ä–∞–≤–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –Ω–∞–ø–∏—à—ñ—Ç—å '–ì–æ—Ç–æ–≤–æ' –∞–±–æ –Ω–∞–¥—ñ—à–ª—ñ—Ç—å —Ö–µ—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó.",
               parse_mode="Markdown"
           )

           # –î–æ–¥–∞—Ç–∫–æ–≤—ñ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ç–µ—Å—Ç–æ–≤–∏—Ö SOL
           await update.message.reply_text(
               "–Ø–∫—â–æ —É –≤–∞—Å –Ω–µ–º–∞—î —Ç–µ—Å—Ç–æ–≤–∏—Ö SOL, –≤–∏ –º–æ–∂–µ—Ç–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ —ó—Ö –Ω–∞ Solana Devnet Faucet:\n"
               "https://solfaucet.com/"
           )

           return WALLET_SIGNATURE  # –¢–µ–ø–µ—Ä —Ü–µ –±—É–¥–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó, –∞ –Ω–µ –ø—ñ–¥–ø–∏—Å
       except Exception as e:
           logger.error(f"Error in handle_wallet_address: {e}", exc_info=True)
           await update.message.reply_text(
               "–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–±—Ä–æ–±—Ü—ñ –∞–¥—Ä–µ—Å–∏ –≥–∞–º–∞–Ω—Ü—è. –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ –±–µ–∑ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è."
           )
           return await self.start_registration_after_wallet(update, context)

   async def verify_transaction(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–æ–±–∫–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è —Ç–µ—Å—Ç–æ–≤–æ—ó —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó –∑–∞–º—ñ—Å—Ç—å –ø—ñ–¥–ø–∏—Å—É"""
       try:
           user_message = update.message.text.strip()
           wallet_address = context.user_data.get('wallet_address')

           # –î–ª—è —Ö–∞–∫–∞—Ç–æ–Ω—É –º–∏ –ø—Ä–æ—Å—Ç–æ –ø—Ä–∏–π–º–∞—î–º–æ –±—É–¥—å-—è–∫–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è
           # –í —Ä–µ–∞–ª—å–Ω–æ–º—É –¥–æ–¥–∞—Ç–∫—É –º–∏ –± –ø–µ—Ä–µ–≤—ñ—Ä—è–ª–∏ —Ö–µ—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
           is_verified = True
           message = "–¢–µ—Å—Ç–æ–≤–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∞"

           if user_message.lower() == "–≥–æ—Ç–æ–≤–æ" or len(user_message) > 30:  # –ü—Ä–æ—Å—Ç–∏–π —Ö–µ–≤—Ä—ñ—Å—Ç–∏—á–Ω–∏–π –ø—ñ–¥—Ö—ñ–¥
               # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é —á–µ—Ä–µ–∑ SolanaIntegration
               is_verified, message = await self.solana.verify_wallet_ownership(
                   wallet_address,
                   user_message if len(user_message) > 30 else None,  # –ú–æ–∂–ª–∏–≤–∏–π —Ö–µ—à —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó
                   context.user_data.get('verification_amount')
               )

           if is_verified:
               # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –≥–∞–º–∞–Ω–µ—Ü—å —É –ø—Ä–æ—Ñ—ñ–ª—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
               context.user_data['wallet_verified'] = True
               context.user_data['verified_wallet'] = wallet_address

               user_id = update.effective_user.id
               bonus_amount = 100  # –ö—ñ–ª—å–∫—ñ—Å—Ç—å –±–æ–Ω—É—Å–Ω–∏—Ö —Ç–æ–∫–µ–Ω—ñ–≤

               await update.message.reply_text(
                   "üéâ –í—ñ—Ç–∞—î–º–æ! –í–∞—à –≥–∞–º–∞–Ω–µ—Ü—å —É—Å–ø—ñ—à–Ω–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–æ!\n\n"
                   f"–í–∏ –æ—Ç—Ä–∏–º–∞—î—Ç–µ {bonus_amount} –±–æ–Ω—É—Å–Ω–∏—Ö —Ç–æ–∫–µ–Ω—ñ–≤ –ø—ñ—Å–ª—è –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó!\n\n"
                   "–¢–µ–ø–µ—Ä –¥–∞–≤–∞–π—Ç–µ –ø—Ä–æ–¥–æ–≤–∂–∏–º–æ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é."
               )

               # –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –∑–≤–∏—á–∞–π–Ω–æ—ó —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
               return await self.start_registration_after_wallet(update, context)
           else:
               await update.message.reply_text(
                   "‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—é. –ú–æ–∂–ª–∏–≤—ñ –ø—Ä–∏—á–∏–Ω–∏:\n"
                   "- –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è —â–µ –Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–∞ –≤ –º–µ—Ä–µ–∂—ñ\n"
                   "- –í—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–∞ —Å—É–º–∞\n"
                   "- –¢—Ä–∞–Ω–∑–∞–∫—Ü—ñ—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–∞ –∑ —ñ–Ω—à–æ–≥–æ –≥–∞–º–∞–Ω—Ü—è\n\n"
                   "–ë–∞–∂–∞—î—Ç–µ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑ —á–∏ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –±–µ–∑ –≥–∞–º–∞–Ω—Ü—è?"
               )
               keyboard = [
                   [InlineKeyboardButton("üîÑ –°–ø—Ä–æ–±—É–≤–∞—Ç–∏ —â–µ —Ä–∞–∑", callback_data="connect_phantom")],
                   [InlineKeyboardButton("‚è≠Ô∏è –ü—Ä–æ–¥–æ–≤–∂–∏—Ç–∏ –±–µ–∑ –≥–∞–º–∞–Ω—Ü—è", callback_data="skip_wallet")]
               ]
               reply_markup = InlineKeyboardMarkup(keyboard)
               await update.message.reply_text("–©–æ –æ–±–∏—Ä–∞—î—Ç–µ?", reply_markup=reply_markup)
               return WALLET_VERIFICATION
       except Exception as e:
           logger.error(f"Error in verify_transaction: {e}", exc_info=True)
           await update.message.reply_text(
               "–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≤—ñ—Ä—Ü—ñ —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ—ó. –ü—Ä–æ–¥–æ–≤–∂—É—î–º–æ –±–µ–∑ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –≥–∞–º–∞–Ω—Ü—è."
           )
           return await self.start_registration_after_wallet(update, context)

   async def start_registration_after_wallet(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–ü–æ—á–∏–Ω–∞—î–º–æ –∑–≤–∏—á–∞–π–Ω—É —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –ø—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ—ó –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –≥–∞–º–∞–Ω—Ü—è"""
       try:
           # –ü—Ä–æ—Å—Ç–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î–º–æ —ñ—Å–Ω—É—é—á—É –ª–æ–≥—ñ–∫—É —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –∑ –≤–∏–±–æ—Ä—É —Å—Ç–∞—Ç—ñ
           keyboard = [
               [KeyboardButton("–ß–æ–ª–æ–≤—ñ–∫")],
               [KeyboardButton("–ñ—ñ–Ω–∫–∞")]
           ]
           reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

           await update.message.reply_text(
               "–í—ñ—Ç–∞—î–º–æ! –î–∞–≤–∞–π—Ç–µ —Å—Ç–≤–æ—Ä–∏–º–æ –≤–∞—à –ø—Ä–æ—Ñ—ñ–ª—å.\n"
               "–í–∏–±–µ—Ä—ñ—Ç—å –≤–∞—à—É —Å—Ç–∞—Ç—å:",
               reply_markup=reply_markup
           )
           return GENDER
       except Exception as e:
           logger.error(f"Error in start_registration_after_wallet: {e}", exc_info=True)
           # –Ø–∫—â–æ —Å—Ç–∞–ª–∞—Å—è –ø–æ–º–∏–ª–∫–∞, –≤—Å–µ –æ–¥–Ω–æ –ø—Ä–æ–±—É—î–º–æ –ø–æ—á–∞—Ç–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é
           keyboard = [
               [KeyboardButton("–ß–æ–ª–æ–≤—ñ–∫")],
               [KeyboardButton("–ñ—ñ–Ω–∫–∞")]
           ]
           reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

           await update.message.reply_text(
               "–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞, –∞–ª–µ –¥–∞–≤–∞–π—Ç–µ –ø—Ä–æ–¥–æ–≤–∂–∏–º–æ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é.\n"
               "–í–∏–±–µ—Ä—ñ—Ç—å –≤–∞—à—É —Å—Ç–∞—Ç—å:",
               reply_markup=reply_markup
           )
           return GENDER

   async def gender(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–æ–±–∫–∞ –≤–∏–±–æ—Ä—É —Å—Ç–∞—Ç—ñ"""
       gender = update.message.text
       context.user_data['gender'] = gender

       keyboard = [
           [KeyboardButton("–°—Ç–æ—Å—É–Ω–∫–∏ (–ø–æ–∫–∞–∑—É–≤–∞—Ç–∏–º–µ–º–æ —Ç—ñ–ª—å–∫–∏ –æ—Å—ñ–± –ø—Ä–æ—Ç–∏–ª–µ–∂–Ω–æ—ó —Å—Ç–∞—Ç—ñ)")],
           [KeyboardButton("–î—Ä—É–∂–±–∞ (–ø–æ–∫–∞–∑—É–≤–∞—Ç–∏–º–µ–º–æ —Ç—ñ–ª—å–∫–∏ –æ—Å—ñ–± —è–∫—ñ –æ–±—Ä–∞–ª–∏ –≤–∞—Ä—ñ–∞–Ω—Ç –¥—Ä—É–∂–±–∞)")]
       ]
       reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

       await update.message.reply_text(
           "–Ø–∫–∞ –º–µ—Ç–∞ –∑–Ω–∞–π–æ–º—Å—Ç–≤–∞?",
           reply_markup=reply_markup
       )
       return PURPOSE

   async def purpose(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–æ–±–∫–∞ –≤–∏–±–æ—Ä—É –º–µ—Ç–∏ –∑–Ω–∞–π–æ–º—Å—Ç–≤–∞"""
       full_text = update.message.text

       # –í–∏—Ç—è–≥—É—î–º–æ –±–∞–∑–æ–≤—É –º–µ—Ç—É (–°—Ç–æ—Å—É–Ω–∫–∏/–î—Ä—É–∂–±–∞) –±–µ–∑ –ø–æ—è—Å–Ω–µ–Ω–Ω—è –≤ –¥—É–∂–∫–∞—Ö
       if "(" in full_text:
           purpose = full_text.split("(")[0].strip()
       else:
           purpose = full_text.strip()

       context.user_data['purpose'] = purpose

       if purpose == "–°—Ç–æ—Å—É–Ω–∫–∏":
           if context.user_data['gender'] == "–ß–æ–ª–æ–≤—ñ–∫":
               context.user_data['looking_for'] = "–ñ—ñ–Ω–∫–∞"
           else:
               context.user_data['looking_for'] = "–ß–æ–ª–æ–≤—ñ–∫"
       else:
           context.user_data['looking_for'] = "–í—Å—ñ"

       await update.message.reply_text(
           "–Ø–∫ –≤–∞—Å –∑–≤–∞—Ç–∏?",
           reply_markup=ReplyKeyboardRemove()
       )
       return NAME

   async def name(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–æ–±–∫–∞ –≤–≤–µ–¥–µ–Ω–Ω—è —ñ–º–µ–Ω—ñ"""
       context.user_data['name'] = update.message.text
       await update.message.reply_text("–°–∫—ñ–ª—å–∫–∏ –≤–∞–º —Ä–æ–∫—ñ–≤?")
       return AGE

   async def age(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–æ–±–∫–∞ –≤–≤–µ–¥–µ–Ω–Ω—è –≤—ñ–∫—É"""
       try:
           age = int(update.message.text)
           if age < 18:
               await update.message.reply_text("–í–∞–º –º–∞—î –±—É—Ç–∏ –Ω–µ –º–µ–Ω—à–µ 18 —Ä–æ–∫—ñ–≤.")
               return AGE
           context.user_data['age'] = age

           await update.message.reply_text(
               "–í–∫–∞–∂—ñ—Ç—å –≤—ñ–∫–æ–≤–∏–π –¥—ñ–∞–ø–∞–∑–æ–Ω –¥–ª—è –ø–æ—à—É–∫—É (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: 20-30):"
           )
           return AGE_RANGE
       except ValueError:
           await update.message.reply_text("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —á–∏—Å–ª–æ.")
           return AGE

   async def age_range(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–æ–±–∫–∞ –≤–≤–µ–¥–µ–Ω–Ω—è –≤—ñ–∫–æ–≤–æ–≥–æ –¥—ñ–∞–ø–∞–∑–æ–Ω—É"""
       try:
           min_age, max_age = map(int, update.message.text.split('-'))
           if min_age < 18 or max_age < min_age:
               await update.message.reply_text(
                   "–ù–µ–∫–æ—Ä–µ–∫—Ç–Ω–∏–π –≤—ñ–∫–æ–≤–∏–π –¥—ñ–∞–ø–∞–∑–æ–Ω. –ú—ñ–Ω—ñ–º–∞–ª—å–Ω–∏–π –≤—ñ–∫ - 18 —Ä–æ–∫—ñ–≤, "
                   "–º–∞–∫—Å–∏–º–∞–ª—å–Ω–∏–π –≤—ñ–∫ –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ –±—ñ–ª—å—à–µ –º—ñ–Ω—ñ–º–∞–ª—å–Ω–æ–≥–æ."
               )
               return AGE_RANGE

           context.user_data['age_range'] = {'min': min_age, 'max': max_age}
           await update.message.reply_text("–í —è–∫–æ–º—É –º—ñ—Å—Ç—ñ –≤–∏ –∑–Ω–∞—Ö–æ–¥–∏—Ç–µ—Å—å?")
           return CITY
       except ValueError:
           await update.message.reply_text(
               "–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å –¥—ñ–∞–ø–∞–∑–æ–Ω —É —Ñ–æ—Ä–º–∞—Ç—ñ: –º—ñ–Ω-–º–∞–∫—Å (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥: 20-30)"
           )
           return AGE_RANGE

   async def city(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–æ–±–∫–∞ –≤–≤–µ–¥–µ–Ω–Ω—è –º—ñ—Å—Ç–∞"""
       context.user_data['city'] = update.message.text
       await update.message.reply_text("–†–æ–∑–∫–∞–∂—ñ—Ç—å –ø—Ä–æ —Å–µ–±–µ —Ç–∞ —Å–≤–æ—ó —ñ–Ω—Ç–µ—Ä–µ—Å–∏:")
       return INTERESTS

   async def interests(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–æ–±–∫–∞ –≤–≤–µ–¥–µ–Ω–Ω—è —ñ–Ω—Ç–µ—Ä–µ—Å—ñ–≤"""
       context.user_data['interests'] = update.message.text

       keyboard = [[KeyboardButton("–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏")]]
       reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

       await update.message.reply_text(
           "–í–∫–∞–∂—ñ—Ç—å –≤–∞—à Instagram (–∞–±–æ –Ω–∞—Ç–∏—Å–Ω—ñ—Ç—å '–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏'):",
           reply_markup=reply_markup
       )
       return INSTAGRAM

   async def instagram(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–æ–±–∫–∞ –≤–≤–µ–¥–µ–Ω–Ω—è Instagram"""
       text = update.message.text
       if text != "–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏":
           # –û—á–∏—â–∞—î–º–æ –≤–≤–µ–¥–µ–Ω–∏–π –Ω—ñ–∫ –≤—ñ–¥ @ –Ω–∞ –ø–æ—á–∞—Ç–∫—É, —è–∫—â–æ —î
           if text.startswith('@'):
               insta_username = text[1:]
           else:
               insta_username = text

           context.user_data['instagram'] = insta_username

       # –ú–µ–Ω—é –≤–∏–±–æ—Ä—É –º—ñ–∂ —Ñ–æ—Ç–æ —ñ –≤—ñ–¥–µ–æ
       keyboard = [
           [KeyboardButton("–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ")],
           [KeyboardButton("–î–æ–¥–∞—Ç–∏ –≤—ñ–¥–µ–æ")]
       ]
       reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

       await update.message.reply_text(
           "–î–æ–¥–∞–π—Ç–µ –≥–æ–ª–æ–≤–Ω–µ –º–µ–¥—ñ–∞ –¥–ª—è –≤–∞—à–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é:",
           reply_markup=reply_markup
       )

       return MAIN_PHOTO

   async def choose_media_type(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–í–∏–±—ñ—Ä —Ç–∏–ø—É –º–µ–¥—ñ–∞ (—Ñ–æ—Ç–æ –∞–±–æ –≤—ñ–¥–µ–æ)"""
       text = update.message.text

       if text == "–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ":
           await update.message.reply_text(
               "–ù–∞–¥—ñ—à–ª—ñ—Ç—å —Å–≤–æ—î –≥–æ–ª–æ–≤–Ω–µ —Ñ–æ—Ç–æ:",
               reply_markup=ReplyKeyboardRemove()
           )
           context.user_data['media_type'] = 'photo'
       elif text == "–î–æ–¥–∞—Ç–∏ –≤—ñ–¥–µ–æ":
           await update.message.reply_text(
               "–ù–∞–¥—ñ—à–ª—ñ—Ç—å —Å–≤–æ—î –≤—ñ–¥–µ–æ (–¥–æ 15 —Å–µ–∫—É–Ω–¥):",
               reply_markup=ReplyKeyboardRemove()
           )
           context.user_data['media_type'] = 'video'
       else:
           await update.message.reply_text(
               "–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å –æ–¥–∏–Ω –∑ –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤ –Ω–∞ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—ñ."
           )
           return MAIN_PHOTO

       return MAIN_PHOTO

   async def main_photo(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–æ–±–∫–∞ –≥–æ–ª–æ–≤–Ω–æ–≥–æ —Ñ–æ—Ç–æ"""
       photo_file = await update.message.photo[-1].get_file()
       context.user_data['main_photo'] = photo_file.file_id

       # –í–∏–¥–∞–ª—è—î–º–æ –≤—ñ–¥–µ–æ, —è–∫—â–æ –≤–æ–Ω–æ –≤–∂–µ –±—É–ª–æ
       if 'main_video' in context.user_data:
           del context.user_data['main_video']

       # –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ–π–Ω–æ–≥–æ —Å–µ–ª—Ñ—ñ
       keyboard = [[KeyboardButton("–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—é")]]
       reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

       await update.message.reply_text(
           "–§–æ—Ç–æ –¥–æ–¥–∞–Ω–æ! –¢–µ–ø–µ—Ä –∑—Ä–æ–±—ñ—Ç—å —Å–µ–ª—Ñ—ñ –¥–ª—è –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –ø—Ä–æ—Ñ—ñ–ª—é:",
           reply_markup=reply_markup
       )
       return SELFIE_PHOTO

   async def main_video(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–æ–±–∫–∞ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –≤—ñ–¥–µ–æ"""
       video_file = await update.message.video.get_file()
       context.user_data['main_video'] = video_file.file_id

       # –í–∏–¥–∞–ª—è—î–º–æ —Ñ–æ—Ç–æ, —è–∫—â–æ –≤–æ–Ω–æ –≤–∂–µ –±—É–ª–æ
       if 'main_photo' in context.user_data:
           del context.user_data['main_photo']

       # –ü–µ—Ä–µ—Ö—ñ–¥ –¥–æ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ–π–Ω–æ–≥–æ —Å–µ–ª—Ñ—ñ
       keyboard = [[KeyboardButton("–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—é")]]
       reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

       await update.message.reply_text(
           "–í—ñ–¥–µ–æ –¥–æ–¥–∞–Ω–æ! –¢–µ–ø–µ—Ä –∑—Ä–æ–±—ñ—Ç—å —Å–µ–ª—Ñ—ñ –¥–ª—è –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –ø—Ä–æ—Ñ—ñ–ª—é:",
           reply_markup=reply_markup
       )
       return SELFIE_PHOTO

   async def selfie_photo(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–æ–±–∫–∞ —Å–µ–ª—Ñ—ñ"""
       photo_file = await update.message.photo[-1].get_file()
       context.user_data['selfie_photo'] = photo_file.file_id
       return await self.prompt_additional_photos(update)

   async def skip_selfie(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–ü—Ä–æ–ø—É—Å–∫ —Å–µ–ª—Ñ—ñ"""
       return await self.prompt_additional_photos(update)

   async def prompt_additional_photos(self, update: Update):
       """–ó–∞–ø–∏—Ç –Ω–∞ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ–æ—Ç–æ"""
       keyboard = [
           [KeyboardButton("–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ")],
           [KeyboardButton("–î–æ–¥–∞—Ç–∏ –≤—ñ–¥–µ–æ")],
           [KeyboardButton("–ó–∞–≤–µ—Ä—à–∏—Ç–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é")]
       ]
       reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

       await update.message.reply_text(
           "–ë–∞–∂–∞—î—Ç–µ –¥–æ–¥–∞—Ç–∏ —â–µ —Ñ–æ—Ç–æ –∞–±–æ –≤—ñ–¥–µ–æ –¥–æ —Å–≤–æ—î—ó –∞–Ω–∫–µ—Ç–∏?",
           reply_markup=reply_markup
       )
       return ADDITIONAL_PHOTO

   async def additional_photo(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–æ–±–∫–∞ –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö —Ñ–æ—Ç–æ"""
       if 'additional_photos' not in context.user_data:
           context.user_data['additional_photos'] = []

       photo_file = await update.message.photo[-1].get_file()
       context.user_data['additional_photos'].append(photo_file.file_id)

       # –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —É—Å–ø—ñ—à–Ω–µ –¥–æ–¥–∞–≤–∞–Ω–Ω—è
       await update.message.reply_text("–§–æ—Ç–æ –¥–æ–¥–∞–Ω–æ! –ë–∞–∂–∞—î—Ç–µ –¥–æ–¥–∞—Ç–∏ —â–µ –º–µ–¥—ñ–∞?")

       return await self.prompt_additional_photos(update)

   async def additional_video(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–æ–±–∫–∞ –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –≤—ñ–¥–µ–æ"""
       if 'additional_videos' not in context.user_data:
           context.user_data['additional_videos'] = []

       video_file = await update.message.video.get_file()
       context.user_data['additional_videos'].append(video_file.file_id)

       # –ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø—Ä–æ —É—Å–ø—ñ—à–Ω–µ –¥–æ–¥–∞–≤–∞–Ω–Ω—è
       await update.message.reply_text("–í—ñ–¥–µ–æ –¥–æ–¥–∞–Ω–æ! –ë–∞–∂–∞—î—Ç–µ –¥–æ–¥–∞—Ç–∏ —â–µ –º–µ–¥—ñ–∞?")

       return await self.prompt_additional_photos(update)

   async def handle_additional_photo_choice(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–æ–±–∫–∞ –≤–∏–±–æ—Ä—É –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ñ–æ—Ç–æ/–≤—ñ–¥–µ–æ –∞–±–æ –∑–∞–≤–µ—Ä—à–µ–Ω–Ω—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó"""
       logger.info(f"Received message text: '{update.message.text}'")
       text = update.message.text

       if text == "–ó–∞–≤–µ—Ä—à–∏—Ç–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é":
           try:
               user_id = update.effective_user.id
               user_data = context.user_data.copy()
               user_data['user_id'] = user_id
               user_data['active'] = True  # –ü–æ–∑–Ω–∞—á–∞—î–º–æ –ø—Ä–æ—Ñ—ñ–ª—å —è–∫ –∞–∫—Ç–∏–≤–Ω–∏–π
               user_data['created_at'] = datetime.now()

               # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ username –¥–ª—è –ø–æ—Å–∏–ª–∞–Ω—å –Ω–∞ –∫–æ–Ω—Ç–∞–∫—Ç –ø—Ä–∏ –º–∞—Ç—á–∞—Ö
               if update.effective_user.username:
                   user_data['username'] = update.effective_user.username

               # –°–ø–æ—á–∞—Ç–∫—É –≤—ñ–¥–∑–Ω–∞—á–∞—î–º–æ –≤—Å—ñ —Å—Ç–∞—Ä—ñ –ø—Ä–æ—Ñ—ñ–ª—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —è–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ñ
               self.users.update_many(
                   {"user_id": user_id, "active": True},
                   {"$set": {"active": False, "deleted_at": datetime.now()}}
               )

               # –¢–µ–ø–µ—Ä —Å—Ç–≤–æ—Ä—é—î–º–æ –Ω–æ–≤–∏–π –ø—Ä–æ—Ñ—ñ–ª—å
               result = self.users.insert_one(user_data)
               logger.info(f"Inserted new user with id: {result.inserted_id}")

               # –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –±–æ–Ω—É—Å–Ω—ñ —Ç–æ–∫–µ–Ω–∏, —è–∫—â–æ –≥–∞–º–∞–Ω–µ—Ü—å –±—É–ª–æ –≤–µ—Ä–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ
               if user_data.get('wallet_verified') and user_data.get('verified_wallet'):
                   bonus_amount = 100
                   await self.token_system.add_tokens(user_id, bonus_amount, "signup_bonus")
                   bonus_message = f"üéÅ –í–∞–º –Ω–∞—Ä–∞—Ö–æ–≤–∞–Ω–æ {bonus_amount} –±–æ–Ω—É—Å–Ω–∏—Ö —Ç–æ–∫–µ–Ω—ñ–≤ –∑–∞ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—é –≥–∞–º–∞–Ω—Ü—è!"
               else:
                   bonus_message = ""

               # –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —á—ñ—Ç–∫–∏–π —Ä–æ–∑–¥—ñ–ª—å–Ω–∏–∫ –º—ñ–∂ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—î—é —Ç–∞ –ø–µ—Ä–µ–≥–ª—è–¥–æ–º –∞–Ω–∫–µ—Ç
               divider = "=" * 30
               welcome_message = (
                   f"{divider}\n\n"
                   f"‚úÖ –†–µ—î—Å—Ç—Ä–∞—Ü—ñ—è —É—Å–ø—ñ—à–Ω–æ –∑–∞–≤–µ—Ä—à–µ–Ω–∞! ‚úÖ\n\n"
                   f"{bonus_message}\n\n" if bonus_message else "\n"
                   f"–¢–µ–ø–µ—Ä –≤–∏ –º–æ–∂–µ—Ç–µ –ø–æ—á–∞—Ç–∏ –ø–µ—Ä–µ–≥–ª—è–¥ –∞–Ω–∫–µ—Ç —ñ –∑–Ω–∞—Ö–æ–¥–∏—Ç–∏ –Ω–æ–≤—ñ –∑–Ω–∞–π–æ–º—Å—Ç–≤–∞.\n\n"
                   f"{divider}"
               )

               await update.message.reply_text(welcome_message)

               # –ù–æ–≤–µ –º–µ–Ω—é –∑ –µ–º–æ–¥–∑—ñ –∫–Ω–æ–ø–∫–∞–º–∏
               keyboard = [
                   [KeyboardButton("üë§ –î–∏–≤–∏—Ç–∏—Å—å –∞–Ω–∫–µ—Ç–∏")],
                   [KeyboardButton("‚ù§Ô∏è –ú–æ—ó –ª–∞–π–∫–∏")],
                   [KeyboardButton("üìù –ú–æ—ó –ø–∞—Ä–∏")],
                   [KeyboardButton("‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è")]
               ]
               reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

               await update.message.reply_text(
                   "–û–±–µ—Ä—ñ—Ç—å –ø–æ—Ç—Ä—ñ–±–Ω—É –æ–ø—Ü—ñ—é:",
                   reply_markup=reply_markup
               )

               # –ü–æ–∫–∞–∑—É—î–º–æ –ø–µ—Ä—à—É –∞–Ω–∫–µ—Ç—É –æ–¥—Ä–∞–∑—É –ø—ñ—Å–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó
               # –©–æ–± –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑—Ä–æ–∑—É–º—ñ–≤, —è–∫ —Ü–µ –ø—Ä–∞—Ü—é—î
               return await self.handle_view_profiles(update, context)
           except Exception as e:
               logger.error(f"Error in completing registration: {e}", exc_info=True)
               await update.message.reply_text("–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.")
               return ADDITIONAL_PHOTO
       elif text == "–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ":
           await update.message.reply_text("–ù–∞–¥—ñ—à–ª—ñ—Ç—å —â–µ –æ–¥–Ω–µ —Ñ–æ—Ç–æ:")
           return ADDITIONAL_PHOTO
       elif text == "–î–æ–¥–∞—Ç–∏ –≤—ñ–¥–µ–æ":
           await update.message.reply_text("–ù–∞–¥—ñ—à–ª—ñ—Ç—å –≤—ñ–¥–µ–æ (–¥–æ 15 —Å–µ–∫—É–Ω–¥):")
           return ADDITIONAL_PHOTO
       else:
           await update.message.reply_text("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å –æ–¥–∏–Ω –∑ –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤ –Ω–∞ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—ñ.")
           return ADDITIONAL_PHOTO

   async def boost_profile(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–ë—É—Å—Ç –ø—Ä–æ—Ñ—ñ–ª—é –∑–∞ —Ç–æ–∫–µ–Ω–∏ - –ø—ñ–¥–≤–∏—â—É—î —à–∞–Ω—Å –ø–æ–∫–∞–∑—É –≤ –ø–æ—à—É–∫—É"""
       try:
           user_id = update.effective_user.id
           boost_cost = 50  # –í–∞—Ä—Ç—ñ—Å—Ç—å –±—É—Å—Ç–∞ –≤ —Ç–æ–∫–µ–Ω–∞—Ö

           # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –±–∞–ª–∞–Ω—Å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
           balance = await self.token_system.get_token_balance(user_id)

           if balance < boost_cost:
               await update.message.reply_text(
                   f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ —Ç–æ–∫–µ–Ω—ñ–≤ –¥–ª—è –±—É—Å—Ç–∞ –ø—Ä–æ—Ñ—ñ–ª—é.\n"
                   f"–í–∞—à –±–∞–ª–∞–Ω—Å: {balance} —Ç–æ–∫–µ–Ω—ñ–≤.\n"
                   f"–í–∞—Ä—Ç—ñ—Å—Ç—å –±—É—Å—Ç–∞: {boost_cost} —Ç–æ–∫–µ–Ω—ñ–≤."
               )
               return VIEWING_PROFILES

           # –°–ø–∏—Å—É—î–º–æ —Ç–æ–∫–µ–Ω–∏
           success, new_balance = await self.token_system.use_tokens(user_id, boost_cost, "profile_boost")

           if success:
               # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –±—É—Å—Ç –¥–ª—è –ø—Ä–æ—Ñ—ñ–ª—é
               boost_until = datetime.now() + timedelta(hours=24)  # –ë—É—Å—Ç –Ω–∞ 24 –≥–æ–¥–∏–Ω–∏

               self.users.update_one(
                   {"user_id": user_id, "active": True},
                   {"$set": {
                       "boosted": True,
                       "boost_until": boost_until
                   }}
               )

               await update.message.reply_text(
                   "üöÄ –í–∞—à –ø—Ä–æ—Ñ—ñ–ª—å –æ—Ç—Ä–∏–º–∞–≤ –±—É—Å—Ç –Ω–∞ 24 –≥–æ–¥–∏–Ω–∏!\n"
                   "–¢–µ–ø–µ—Ä –≤—ñ–Ω –º–∞—î –ø—ñ–¥–≤–∏—â–µ–Ω–∏–π –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç —É –≤–∏–¥–∞—á—ñ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤ –ø–æ—à—É–∫—É.\n\n"
                   f"–ó –≤–∞—à–æ–≥–æ –±–∞–ª–∞–Ω—Å—É —Å–ø–∏—Å–∞–Ω–æ {boost_cost} —Ç–æ–∫–µ–Ω—ñ–≤.\n"
                   f"–ü–æ—Ç–æ—á–Ω–∏–π –±–∞–ª–∞–Ω—Å: {new_balance} —Ç–æ–∫–µ–Ω—ñ–≤."
               )
           else:
               await update.message.reply_text(
                   "‚ùå –í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–Ω—ñ —Ç–æ–∫–µ–Ω—ñ–≤. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ."
               )

           return VIEWING_PROFILES
       except Exception as e:
           logger.error(f"Error in boost_profile: {e}", exc_info=True)
           await update.message.reply_text(
               "‚ùå –í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –±—É—Å—Ç–∞. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ."
           )
           return VIEWING_PROFILES

   async def super_like(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """Super Like - –≥–∞—Ä–∞–Ω—Ç–æ–≤–∞–Ω–∏–π –ø–æ–∫–∞–∑ –≤–∞—à–æ–≥–æ –ª–∞–π–∫—É —ñ–Ω—à–æ–º—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É"""
       try:
           user_id = update.effective_user.id
           super_like_cost = 30  # –í–∞—Ä—Ç—ñ—Å—Ç—å Super Like –≤ —Ç–æ–∫–µ–Ω–∞—Ö

           # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ –±–∞–ª–∞–Ω—Å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
           balance = await self.token_system.get_token_balance(user_id)

           if balance < super_like_cost:
               await update.message.reply_text(
                   f"‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ —Ç–æ–∫–µ–Ω—ñ–≤ –¥–ª—è Super Like.\n"
                   f"–í–∞—à –±–∞–ª–∞–Ω—Å: {balance} —Ç–æ–∫–µ–Ω—ñ–≤.\n"
                   f"–í–∞—Ä—Ç—ñ—Å—Ç—å Super Like: {super_like_cost} —Ç–æ–∫–µ–Ω—ñ–≤."
               )
               return VIEWING_PROFILES

           # –û—Ç—Ä–∏–º—É—î–º–æ ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —è–∫–æ–º—É —Ö–æ—á–µ–º–æ –∑—Ä–æ–±–∏—Ç–∏ Super Like
           if 'current_profile_id' not in context.user_data:
               await update.message.reply_text(
                   "‚ùå –°–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –ø—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —è–∫–æ–º—É —Ö–æ—á–µ—Ç–µ –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ Super Like."
               )
               return VIEWING_PROFILES

           target_user_id = context.user_data.get('current_profile_id')

           # –°–ø–∏—Å—É—î–º–æ —Ç–æ–∫–µ–Ω–∏
           success, new_balance = await self.token_system.use_tokens(user_id, super_like_cost, "super_like")

           if success:
               # –°—Ç–≤–æ—Ä—é—î–º–æ Super Like –∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏–º –≤—ñ–¥–º—ñ—Ç–∫–æ–º
               success, message = await self.like_system.create_like(user_id, target_user_id)

               if success:
                   # –°–ø—Ä–æ–±—É—î–º–æ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ —Å–ø–æ–≤—ñ—â–µ–Ω–Ω—è –ø—Ä–æ Super Like –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
                   try:
                       user = self.users.find_one({"user_id": user_id, "active": True})

                       if user:
                           target_user = self.users.find_one({"user_id": target_user_id, "active": True})

                           if target_user:
                               notification_text = (
                                   "üåü SUPER LIKE! üåü\n\n"
                                   f"–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á {user.get('name', '–ù–µ–≤—ñ–¥–æ–º–∏–π')}, {user.get('age', '?')} "
                                   f"–Ω–∞–¥—ñ—Å–ª–∞–≤ –≤–∞–º SUPER LIKE!\n\n"
                                   "–ü–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ '–ú–æ—ó –ª–∞–π–∫–∏', —â–æ–± –¥—ñ–∑–Ω–∞—Ç–∏—Å—è –±—ñ–ª—å—à–µ!"
                               )

                               await self.bot.send_message(
                                   chat_id=target_user_id,
                                   text=notification_text
                               )

                               # –î–æ–¥–∞—î–º–æ –∑–∞–ø–∏—Å –ø—Ä–æ Super Like –≤ –±–∞–∑—É
                               self.likes.update_one(
                                   {"from_user": user_id, "to_user": target_user_id},
                                   {"$set": {"super_like": True, "super_like_time": datetime.now()}}
                               )
                   except Exception as e:
                       logger.error(f"Error notifying about Super Like: {e}", exc_info=True)

                   await update.message.reply_text(
                       "üåü –í–∏ —É—Å–ø—ñ—à–Ω–æ –≤—ñ–¥–ø—Ä–∞–≤–∏–ª–∏ Super Like!\n"
                       "–¶–µ –∑–Ω–∞—á–Ω–æ –ø—ñ–¥–≤–∏—â—É—î –≤–∞—à—ñ —à–∞–Ω—Å–∏ –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤—ñ–¥–ø–æ–≤—ñ–¥—å.\n\n"
                       f"–ó –≤–∞—à–æ–≥–æ –±–∞–ª–∞–Ω—Å—É —Å–ø–∏—Å–∞–Ω–æ {super_like_cost} —Ç–æ–∫–µ–Ω—ñ–≤.\n"
                       f"–ü–æ—Ç–æ—á–Ω–∏–π –±–∞–ª–∞–Ω—Å: {new_balance} —Ç–æ–∫–µ–Ω—ñ–≤."
                   )
               else:
                   # –Ø–∫—â–æ –Ω–µ –≤–¥–∞–ª–æ—Å—è —Å—Ç–≤–æ—Ä–∏—Ç–∏ –ª–∞–π–∫, –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ —Ç–æ–∫–µ–Ω–∏
                   await self.token_system.add_tokens(user_id, super_like_cost, "super_like_refund")
                   await update.message.reply_text(
                       f"‚ùå –ù–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ Super Like: {message}\n"
                       f"–¢–æ–∫–µ–Ω–∏ –ø–æ–≤–µ—Ä–Ω—É—Ç–æ –Ω–∞ –≤–∞—à –±–∞–ª–∞–Ω—Å."
                   )
           else:
               await update.message.reply_text(
                   "‚ùå –í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ —Å–ø–∏—Å–∞–Ω–Ω—ñ —Ç–æ–∫–µ–Ω—ñ–≤. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ."
               )

           return VIEWING_PROFILES
       except Exception as e:
           logger.error(f"Error in super_like: {e}", exc_info=True)
           await update.message.reply_text(
               "‚ùå –í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–ø—Ä–∞–≤—Ü—ñ Super Like. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ."
           )
           return VIEWING_PROFILES

   async def settings(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é –∑ Web3 —Ñ—É–Ω–∫—Ü—ñ—è–º–∏"""
       try:
           user_id = update.effective_user.id
           balance = await self.token_system.get_token_balance(user_id)

           # –î–æ–¥–∞—î–º–æ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –ø—Ä–æ –±–∞–ª–∞–Ω—Å —Ç–æ–∫–µ–Ω—ñ–≤
           balance_text = f"üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å: {balance} —Ç–æ–∫–µ–Ω—ñ–≤"

           keyboard = [
               [KeyboardButton("üíé –ü—Ä–µ–º—ñ—É–º –∞–∫–∞—É–Ω—Ç")],
               [KeyboardButton("üöÄ –ë—É—Å—Ç –∞–∫–∞—É–Ω—Ç—É")],
               [KeyboardButton("üí∞ –ú—ñ–π –≥–∞–º–∞–Ω–µ—Ü—å")],  # –ù–æ–≤–∞ –æ–ø—Ü—ñ—è –¥–ª—è Web3
               [KeyboardButton("üë§ –ú–æ—è –∞–Ω–∫–µ—Ç–∞")],
               [KeyboardButton("üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ –∞–Ω–∫–µ—Ç—É")],
               [KeyboardButton("üîô –ù–∞–∑–∞–¥")]
           ]
           reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

           await update.message.reply_text(
               f"–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è:\n\n{balance_text}",
               reply_markup=reply_markup
           )
           return SETTINGS
       except Exception as e:
           logger.error(f"Error in settings: {e}", exc_info=True)
           # –£ –≤–∏–ø–∞–¥–∫—É –ø–æ–º–∏–ª–∫–∏ –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é
           keyboard = [
               [KeyboardButton("üë§ –î–∏–≤–∏—Ç–∏—Å—å –∞–Ω–∫–µ—Ç–∏")],
               [KeyboardButton("‚ù§Ô∏è –ú–æ—ó –ª–∞–π–∫–∏")],
               [KeyboardButton("üìù –ú–æ—ó –ø–∞—Ä–∏")],
               [KeyboardButton("‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è")]
           ]
           reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
           await update.message.reply_text(
               "–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞. –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é:",
               reply_markup=reply_markup
           )
           return VIEWING_PROFILES

   async def wallet_settings(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≥–∞–º–∞–Ω—Ü—è"""
       try:
           user_id = update.effective_user.id
           user = self.users.find_one({"user_id": user_id, "active": True})

           # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –≤–µ—Ä–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π –≥–∞–º–∞–Ω–µ—Ü—å
           wallet_text = "–ì–∞–º–∞–Ω–µ—Ü—å –Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ"
           if user and user.get('verified_wallet'):
               wallet_address = user.get('verified_wallet')
               # –ú–∞—Å–∫—É—î–º–æ –∞–¥—Ä–µ—Å—É –≥–∞–º–∞–Ω—Ü—è –¥–ª—è –±–µ–∑–ø–µ–∫–∏
               masked_address = f"{wallet_address[:6]}...{wallet_address[-4:]}"
               wallet_text = f"–ü—ñ–¥–∫–ª—é—á–µ–Ω–∏–π –≥–∞–º–∞–Ω–µ—Ü—å: {masked_address}"

           # –û—Ç—Ä–∏–º—É—î–º–æ –±–∞–ª–∞–Ω—Å —Ç–æ–∫–µ–Ω—ñ–≤
           balance = await self.token_system.get_token_balance(user_id)
           balance_text = f"–í–∞—à –±–∞–ª–∞–Ω—Å: {balance} —Ç–æ–∫–µ–Ω—ñ–≤"

           # –û—Ç—Ä–∏–º—É—î–º–æ —ñ—Å—Ç–æ—Ä—ñ—é —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π —Ç–æ–∫–µ–Ω—ñ–≤
           token_history = []
           if user and 'token_history' in user:
               token_history = user.get('token_history', [])[-5:]  # –û—Å—Ç–∞–Ω–Ω—ñ 5 —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π

           history_text = "–Ü—Å—Ç–æ—Ä—ñ—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π:"
           if token_history:
               for idx, tx in enumerate(reversed(token_history), 1):
                   amount = tx.get('amount', 0)
                   reason = tx.get('reason', tx.get('feature', '–Ω–µ–≤—ñ–¥–æ–º–æ'))
                   timestamp = tx.get('timestamp', datetime.now()).strftime('%d.%m.%Y %H:%M')
                   sign = "+" if amount > 0 else ""
                   history_text += f"\n{idx}. {sign}{amount} —Ç–æ–∫–µ–Ω—ñ–≤ - {reason} ({timestamp})"
           else:
               history_text += "\n–£ –≤–∞—Å –ø–æ–∫–∏ –Ω–µ–º–∞—î —Ç—Ä–∞–Ω–∑–∞–∫—Ü—ñ–π"

           keyboard = [
               [KeyboardButton("üí∞ –û—Ç—Ä–∏–º–∞—Ç–∏ –±—ñ–ª—å—à–µ —Ç–æ–∫–µ–Ω—ñ–≤")],
               [KeyboardButton("üîÑ –ü—ñ–¥–∫–ª—é—á–∏—Ç–∏ —ñ–Ω—à–∏–π –≥–∞–º–∞–Ω–µ—Ü—å")],
               [KeyboardButton("üîô –ù–∞–∑–∞–¥")]
           ]
           reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

           await update.message.reply_text(
               f"üíº –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –≥–∞–º–∞–Ω—Ü—è\n\n"
               f"üìü {wallet_text}\n\n"
               f"üí∞ {balance_text}\n\n"
               f"üìã {history_text}",
               reply_markup=reply_markup
           )

           return SETTINGS
       except Exception as e:
           logger.error(f"Error in wallet_settings: {e}", exc_info=True)
           await update.message.reply_text("–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—ñ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å –≥–∞–º–∞–Ω—Ü—è.")
           return SETTINGS

   async def handle_premium_account(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–æ–±–∫–∞ –ø—Ä–µ–º—ñ—É–º –∞–∫–∞—É–Ω—Ç—É"""
       # –¢–∏–º—á–∞—Å–æ–≤–∏–π –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è —Ñ—É–Ω–∫—Ü—ñ—ó Premium
       await update.message.reply_text(
           "üöß –§—É–Ω–∫—Ü—ñ—è –ü—Ä–µ–º—ñ—É–º –∞–∫–∞—É–Ω—Ç –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ —Ä–æ–∑—Ä–æ–±—Ü—ñ.\n"
           "–°–∫–æ—Ä–æ –≤–∏ –∑–º–æ–∂–µ—Ç–µ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—è –≤—Å—ñ–º–∞ –ø–µ—Ä–µ–≤–∞–≥–∞–º–∏ –ø—Ä–µ–º—ñ—É–º-—Å—Ç–∞—Ç—É—Å—É!"
       )
       return SETTINGS

   async def back_to_main_menu(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–ü–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é"""
       keyboard = [
           [KeyboardButton("üë§ –î–∏–≤–∏—Ç–∏—Å—å –∞–Ω–∫–µ—Ç–∏")],
           [KeyboardButton("‚ù§Ô∏è –ú–æ—ó –ª–∞–π–∫–∏")],
           [KeyboardButton("üìù –ú–æ—ó –ø–∞—Ä–∏")],
           [KeyboardButton("‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è")]
       ]
       reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

       await update.message.reply_text(
           "–ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é:",
           reply_markup=reply_markup
       )
       return VIEWING_PROFILES

   async def show_my_profile(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–ü–æ–∫–∞–∑—É—î –≤–ª–∞—Å–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞"""
       try:
           user_id = update.effective_user.id
           user = self.users.find_one({"user_id": user_id, "active": True})

           if not user:
               await update.message.reply_text(
                   "–í–∞—à –ø—Ä–æ—Ñ—ñ–ª—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ. –°–ø—Ä–æ–±—É–π—Ç–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –π–æ–≥–æ –∑–∞–Ω–æ–≤–æ."
               )
               return SETTINGS

           # –§–æ—Ä–º—É—î–º–æ —Ç–µ–∫—Å—Ç –ø—Ä–æ—Ñ—ñ–ª—é
           profile_text = (
               f"üë§ {user.get('name', '–ù–µ –≤–∫–∞–∑–∞–Ω–æ')}, {user.get('age', '–ù–µ –≤–∫–∞–∑–∞–Ω–æ')}\n"
               f"üåÜ {user.get('city', '–ù–µ –≤–∫–∞–∑–∞–Ω–æ')}\n"
               f"üéØ {user.get('purpose', '–ù–µ –≤–∫–∞–∑–∞–Ω–æ')}\n\n"
               f"üìù {user.get('interests', '–ù–µ –≤–∫–∞–∑–∞–Ω–æ')}"
           )

           # –î–æ–¥–∞—î–º–æ Instagram, —è–∫—â–æ —î
           if 'instagram' in user and user['instagram']:
               profile_text += f"\n\nüì∏ Instagram: @{user['instagram']}"

           # –î–æ–¥–∞—î–º–æ —Å—Ç–∞—Ç—É—Å –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
           if 'selfie_photo' in user:
               profile_text += "\n\n‚úÖ –ü—Ä–æ—Ñ—ñ–ª—å –≤–µ—Ä–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ"
           else:
               profile_text += "\n\n‚ö†Ô∏è –ü—Ä–æ—Ñ—ñ–ª—å –Ω–µ –≤–µ—Ä–∏—Ñ—ñ–∫–æ–≤–∞–Ω–æ"

           # –î–æ–¥–∞—î–º–æ —Å—Ç–∞—Ç—É—Å Web3 –≥–∞–º–∞–Ω—Ü—è
           if user.get('wallet_verified'):
               profile_text += "\nüîπ Web3 –≥–∞–º–∞–Ω–µ—Ü—å –ø—ñ–¥–∫–ª—é—á–µ–Ω–æ"

           # –î–æ–¥–∞—î–º–æ —Å—Ç–∞—Ç—É—Å –±—É—Å—Ç—É, —è–∫—â–æ —î
           if user.get('boosted'):
               profile_text += "\nüöÄ –ê–∫—Ç–∏–≤–æ–≤–∞–Ω–æ –±—É—Å—Ç –ø—Ä–æ—Ñ—ñ–ª—é"

           keyboard = [
               [KeyboardButton("üîÑ –ó–∞–ø–æ–≤–Ω–∏—Ç–∏ –∞–Ω–∫–µ—Ç—É –Ω–∞–Ω–æ–≤–æ")],
               [KeyboardButton("üì∏ –ó–º—ñ–Ω–∏—Ç–∏ —Ñ–æ—Ç–æ/–≤—ñ–¥–µ–æ")],
               [KeyboardButton("‚úèÔ∏è –ó–º—ñ–Ω–∏—Ç–∏ —Ç–µ–∫—Å—Ç –∞–Ω–∫–µ—Ç–∏")],
               [KeyboardButton("üîô –ù–∞–∑–∞–¥")]
           ]
           reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

           # –°–ø—Ä–æ–±—É—î–º–æ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≥–æ–ª–æ–≤–Ω–µ —Ñ–æ—Ç–æ –∞–±–æ –≤—ñ–¥–µ–æ
           media_sent = False

           if 'main_photo' in user and user['main_photo']:
               try:
                   await update.message.reply_photo(
                       user['main_photo'],
                       caption=profile_text,
                       reply_markup=reply_markup
                   )
                   media_sent = True
               except Exception as e:
                   logger.error(f"Error sending profile main photo: {e}", exc_info=True)

           if not media_sent and 'main_video' in user and user['main_video']:
               try:
                   await update.message.reply_video(
                       user['main_video'],
                       caption=profile_text,
                       reply_markup=reply_markup
                   )
                   media_sent = True
               except Exception as e:
                   logger.error(f"Error sending profile main video: {e}", exc_info=True)

           if not media_sent:
               await update.message.reply_text(
                   profile_text,
                   reply_markup=reply_markup
               )

           # –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ–æ—Ç–æ
           if 'additional_photos' in user and user['additional_photos']:
               media_group = []

               for photo_id in user['additional_photos']:
                   try:
                       if photo_id:  # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ ID –Ω–µ –ø—É—Å—Ç–∏–π
                           media_group.append(InputMediaPhoto(photo_id))
                   except Exception as e:
                       logger.error(f"Error adding photo to media group: {e}", exc_info=True)

               if media_group:
                   try:
                       await update.message.reply_media_group(media_group)
                   except Exception as e:
                       logger.error(f"Error sending media group: {e}", exc_info=True)

           # –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –≤—ñ–¥–µ–æ
           if 'additional_videos' in user and user['additional_videos']:
               for video_id in user['additional_videos']:
                   try:
                       if video_id:  # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ ID –Ω–µ –ø—É—Å—Ç–∏–π
                           await update.message.reply_video(video_id)
                   except Exception as e:
                       logger.error(f"Error sending additional video: {e}", exc_info=True)

           return MY_PROFILE
       except Exception as e:
           logger.error(f"Error in show_my_profile: {e}", exc_info=True)
           await update.message.reply_text("–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—ñ –≤–∞—à–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é.")
           return SETTINGS

   async def confirm_restart_profile(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–ó–∞–ø–∏—Ç –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É –ø—Ä–æ—Ñ—ñ–ª—é"""
       keyboard = [
           [KeyboardButton("–¢–∞–∫, –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ –∑–∞–Ω–æ–≤–æ")],
           [KeyboardButton("–ù—ñ, –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è")]
       ]
       reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

       await update.message.reply_text(
           "‚ö†Ô∏è –£–≤–∞–≥–∞! –í–∏ –∑–±–∏—Ä–∞—î—Ç–µ—Å—è –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ –∞–Ω–∫–µ—Ç—É –∑–∞–Ω–æ–≤–æ. "
           "–í—Å—ñ –≤–∞—à—ñ –ø–æ—Ç–æ—á–Ω—ñ –¥–∞–Ω—ñ –∞–Ω–∫–µ—Ç–∏ —Ç–∞ –ª–∞–π–∫–∏ –±—É–¥—É—Ç—å –≤–∏–¥–∞–ª–µ–Ω—ñ. "
           "–ß–∏ –±–∞–∂–∞—î—Ç–µ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?",
           reply_markup=reply_markup
       )
       return CONFIRM_RESTART

   async def handle_restart_confirmation(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–æ–±–∫–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫—É –ø—Ä–æ—Ñ—ñ–ª—é"""
       if update.message.text == "–¢–∞–∫, –∑–∞–ø–æ–≤–Ω–∏—Ç–∏ –∑–∞–Ω–æ–≤–æ":
           await update.message.reply_text(
               "üìù –ü–æ—á–∏–Ω–∞—î–º–æ –∑–∞–ø–æ–≤–Ω–µ–Ω–Ω—è –∞–Ω–∫–µ—Ç–∏ –∑–∞–Ω–æ–≤–æ..."
           )
           return await self.start(update, context)
       else:
           await update.message.reply_text("–ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –¥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É –≤–∞—à–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é")
           return await self.show_my_profile(update, context)

   async def confirm_delete_profile(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–ó–∞–ø–∏—Ç –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é"""
       keyboard = [
           [KeyboardButton("–¢–∞–∫, –≤–∏–¥–∞–ª–∏—Ç–∏")],
           [KeyboardButton("–ù—ñ, –ø–æ–≤–µ—Ä–Ω—É—Ç–∏—Å—è")]
       ]
       reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

       await update.message.reply_text(
           "‚ö†Ô∏è –£–≤–∞–≥–∞! –í–∏ –∑–±–∏—Ä–∞—î—Ç–µ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ —Å–≤—ñ–π –ø—Ä–æ—Ñ—ñ–ª—å. "
           "–í—Å—ñ –≤–∞—à—ñ –¥–∞–Ω—ñ –∞–Ω–∫–µ—Ç–∏, –ª–∞–π–∫–∏ —Ç–∞ –º–∞—Ç—á—ñ –±—É–¥—É—Ç—å –≤–∏–¥–∞–ª–µ–Ω—ñ. "
           "–ß–∏ –±–∞–∂–∞—î—Ç–µ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç–∏?",
           reply_markup=reply_markup
       )
       return CONFIRM_DELETE

   async def handle_delete_confirmation(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–æ–±–∫–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –≤–∏–¥–∞–ª–µ–Ω–Ω—è –ø—Ä–æ—Ñ—ñ–ª—é"""
       if update.message.text == "–¢–∞–∫, –≤–∏–¥–∞–ª–∏—Ç–∏":
           try:
               user_id = update.effective_user.id
               delete_time = datetime.now()

               # –ü–æ–∑–Ω–∞—á–∞—î–º–æ –ø—Ä–æ—Ñ—ñ–ª—å —è–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω–∏–π
               self.users.update_many(
                   {"user_id": user_id},
                   {"$set": {"active": False, "deleted_at": delete_time}}
               )

               # –í–∏–¥–∞–ª—è—î–º–æ –ª–∞–π–∫–∏
               deleted_likes_from = self.likes.delete_many({"from_user": user_id})
               deleted_likes_to = self.likes.delete_many({"to_user": user_id})

               # –ü–æ–∑–Ω–∞—á–∞—î–º–æ –º–∞—Ç—á—ñ —è–∫ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ñ
               updated_matches = self.matches.update_many(
                   {"users": {"$in": [user_id]}},
                   {"$set": {"active": False, "deleted_at": delete_time}}
               )

               logger.info(f"Profile deleted for user {user_id}: marked inactive profile, "
                         f"deleted {deleted_likes_from.deleted_count + deleted_likes_to.deleted_count} likes, "
                         f"marked inactive {updated_matches.modified_count} matches")

               await update.message.reply_text(
                   "–í–∞—à –ø—Ä–æ—Ñ—ñ–ª—å —É—Å–ø—ñ—à–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–æ. "
                   "–í–∏ –º–æ–∂–µ—Ç–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –Ω–æ–≤–∏–π, –Ω–∞–ø–∏—Å–∞–≤—à–∏ /start"
               )

               return ConversationHandler.END
           except Exception as e:
               logger.error(f"Error deleting profile: {e}", exc_info=True)
               await update.message.reply_text(
                   "–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –≤–∏–¥–∞–ª–µ–Ω–Ω—ñ –ø—Ä–æ—Ñ—ñ–ª—é. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑."
               )
               return SETTINGS
       else:
           await update.message.reply_text("–î—ñ—é —Å–∫–∞—Å–æ–≤–∞–Ω–æ. –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –¥–æ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å.")
           return SETTINGS

   async def change_profile_photo(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–ó–º—ñ–Ω–∞ —Ñ–æ—Ç–æ –ø—Ä–æ—Ñ—ñ–ª—é"""
       keyboard = [
           [KeyboardButton("–ó–º—ñ–Ω–∏—Ç–∏ –≥–æ–ª–æ–≤–Ω–µ —Ñ–æ—Ç–æ")],
           [KeyboardButton("–ó–º—ñ–Ω–∏—Ç–∏ –≥–æ–ª–æ–≤–Ω–µ –≤—ñ–¥–µ–æ")],
           [KeyboardButton("–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ –¥–æ –≥–∞–ª–µ—Ä–µ—ó")],
           [KeyboardButton("–î–æ–¥–∞—Ç–∏ –≤—ñ–¥–µ–æ –¥–æ –≥–∞–ª–µ—Ä–µ—ó")],
           [KeyboardButton("–û–Ω–æ–≤–∏—Ç–∏ —Å–µ–ª—Ñ—ñ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó")],
           [KeyboardButton("üîô –ù–∞–∑–∞–¥")]
       ]
       reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

       await update.message.reply_text(
           "–í–∏–±–µ—Ä—ñ—Ç—å, —â–æ —Å–∞–º–µ –≤–∏ —Ö–æ—á–µ—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏:",
           reply_markup=reply_markup
       )
       return CHANGE_PHOTO

   async def handle_change_photo_choice(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–æ–±–∫–∞ –≤–∏–±–æ—Ä—É –∑–º—ñ–Ω–∏ —Ñ–æ—Ç–æ/–≤—ñ–¥–µ–æ"""
       text = update.message.text

       if text == "–ó–º—ñ–Ω–∏—Ç–∏ –≥–æ–ª–æ–≤–Ω–µ —Ñ–æ—Ç–æ":
           context.user_data['photo_type'] = 'main_photo'
           await update.message.reply_text("–ù–∞–¥—ñ—à–ª—ñ—Ç—å –Ω–æ–≤–µ –≥–æ–ª–æ–≤–Ω–µ —Ñ–æ—Ç–æ:")
           return CHANGE_PHOTO
       elif text == "–ó–º—ñ–Ω–∏—Ç–∏ –≥–æ–ª–æ–≤–Ω–µ –≤—ñ–¥–µ–æ":
           context.user_data['photo_type'] = 'main_video'
           await update.message.reply_text("–ù–∞–¥—ñ—à–ª—ñ—Ç—å –Ω–æ–≤–µ –≥–æ–ª–æ–≤–Ω–µ –≤—ñ–¥–µ–æ (–¥–æ 15 —Å–µ–∫—É–Ω–¥):")
           return CHANGE_PHOTO
       elif text == "–î–æ–¥–∞—Ç–∏ —Ñ–æ—Ç–æ –¥–æ –≥–∞–ª–µ—Ä–µ—ó":
           context.user_data['photo_type'] = 'additional_photo'
           await update.message.reply_text("–ù–∞–¥—ñ—à–ª—ñ—Ç—å —Ñ–æ—Ç–æ, —è–∫–µ —Ö–æ—á–µ—Ç–µ –¥–æ–¥–∞—Ç–∏ –¥–æ –≥–∞–ª–µ—Ä–µ—ó:")
           return CHANGE_PHOTO
       elif text == "–î–æ–¥–∞—Ç–∏ –≤—ñ–¥–µ–æ –¥–æ –≥–∞–ª–µ—Ä–µ—ó":
           context.user_data['photo_type'] = 'additional_video'
           await update.message.reply_text("–ù–∞–¥—ñ—à–ª—ñ—Ç—å –≤—ñ–¥–µ–æ, —è–∫–µ —Ö–æ—á–µ—Ç–µ –¥–æ–¥–∞—Ç–∏ –¥–æ –≥–∞–ª–µ—Ä–µ—ó (–¥–æ 15 —Å–µ–∫—É–Ω–¥):")
           return CHANGE_PHOTO
       elif text == "–û–Ω–æ–≤–∏—Ç–∏ —Å–µ–ª—Ñ—ñ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó":
           context.user_data['photo_type'] = 'selfie_photo'
           await update.message.reply_text("–ù–∞–¥—ñ—à–ª—ñ—Ç—å –Ω–æ–≤–µ —Å–µ–ª—Ñ—ñ –¥–ª—è –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó:")
           return CHANGE_PHOTO
       elif text == "üîô –ù–∞–∑–∞–¥":
           await update.message.reply_text("–ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –¥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É –ø—Ä–æ—Ñ—ñ–ª—é.")
           return await self.show_my_profile(update, context)
       else:
           await update.message.reply_text("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–∏–±–µ—Ä—ñ—Ç—å –æ–¥–∏–Ω –∑ –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤ –Ω–∞ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—ñ.")
           return CHANGE_PHOTO

   async def update_profile_photo(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–Ω–æ–≤–ª–µ–Ω–Ω—è —Ñ–æ—Ç–æ —É –ø—Ä–æ—Ñ—ñ–ª—ñ"""
       try:
           user_id = update.effective_user.id
           photo_type = context.user_data.get('photo_type', 'main_photo')
           photo_file = await update.message.photo[-1].get_file()

           if photo_type == 'main_photo':
               self.users.update_one(
                   {"user_id": user_id, "active": True},
                   {"$set": {"main_photo": photo_file.file_id},
                    "$unset": {"main_video": ""}}  # –í–∏–¥–∞–ª—è—î–º–æ –≤—ñ–¥–µ–æ, —è–∫—â–æ –≤–æ–Ω–æ —î
               )
               await update.message.reply_text("–ì–æ–ª–æ–≤–Ω–µ —Ñ–æ—Ç–æ —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ!")
           elif photo_type == 'selfie_photo':
               self.users.update_one(
                   {"user_id": user_id, "active": True},
                   {"$set": {"selfie_photo": photo_file.file_id}}
               )
               await update.message.reply_text("–°–µ–ª—Ñ—ñ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ!")
           elif photo_type == 'additional_photo':
               self.users.update_one(
                   {"user_id": user_id, "active": True},
                   {"$push": {"additional_photos": photo_file.file_id}}
               )
               await update.message.reply_text("–§–æ—Ç–æ —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ –¥–æ –≥–∞–ª–µ—Ä–µ—ó!")

           return await self.show_my_profile(update, context)
       except Exception as e:
           logger.error(f"Error updating profile photo: {e}", exc_info=True)
           await update.message.reply_text("–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ —Ñ–æ—Ç–æ.")
           return CHANGE_PHOTO

   async def update_profile_video(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–Ω–æ–≤–ª–µ–Ω–Ω—è –≤—ñ–¥–µ–æ —É –ø—Ä–æ—Ñ—ñ–ª—ñ"""
       try:
           user_id = update.effective_user.id
           photo_type = context.user_data.get('photo_type', 'main_video')
           video_file = await update.message.video.get_file()

           if photo_type == 'main_video':
               self.users.update_one(
                   {"user_id": user_id, "active": True},
                   {"$set": {"main_video": video_file.file_id},
                    "$unset": {"main_photo": ""}}  # –í–∏–¥–∞–ª—è—î–º–æ —Ñ–æ—Ç–æ, —è–∫—â–æ –≤–æ–Ω–æ —î
               )
               await update.message.reply_text("–ì–æ–ª–æ–≤–Ω–µ –≤—ñ–¥–µ–æ —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ!")
           elif photo_type == 'additional_video':
               self.users.update_one(
                   {"user_id": user_id, "active": True},
                   {"$push": {"additional_videos": video_file.file_id}}
               )
               await update.message.reply_text("–í—ñ–¥–µ–æ —É—Å–ø—ñ—à–Ω–æ –¥–æ–¥–∞–Ω–æ –¥–æ –≥–∞–ª–µ—Ä–µ—ó!")

           return await self.show_my_profile(update, context)
       except Exception as e:
           logger.error(f"Error updating profile video: {e}", exc_info=True)
           await update.message.reply_text("–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –æ–Ω–æ–≤–ª–µ–Ω–Ω—ñ –≤—ñ–¥–µ–æ.")
           return CHANGE_PHOTO

   async def change_bio(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–ó–º—ñ–Ω–∞ —Ç–µ–∫—Å—Ç–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –≤ –∞–Ω–∫–µ—Ç—ñ"""
       keyboard = [
           [KeyboardButton("–ó–º—ñ–Ω–∏—Ç–∏ —ñ–º'—è")],
           [KeyboardButton("–ó–º—ñ–Ω–∏—Ç–∏ –≤—ñ–∫")],
           [KeyboardButton("–ó–º—ñ–Ω–∏—Ç–∏ –º—ñ—Å—Ç–æ")],
           [KeyboardButton("–ó–º—ñ–Ω–∏—Ç–∏ –æ–ø–∏—Å")],
           [KeyboardButton("–ó–º—ñ–Ω–∏—Ç–∏ Instagram")],
           [KeyboardButton("üîô –ù–∞–∑–∞–¥")]
       ]
       reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

       await update.message.reply_text(
           "–í–∏–±–µ—Ä—ñ—Ç—å, —è–∫—É —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –≤–∏ —Ö–æ—á–µ—Ç–µ –∑–º—ñ–Ω–∏—Ç–∏:",
           reply_markup=reply_markup
       )
       return CHANGE_BIO

   async def edit_name(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —ñ–º–µ–Ω—ñ"""
       await update.message.reply_text("–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤–µ —ñ–º'—è:")
       return EDIT_NAME

   async def save_name(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ —ñ–º–µ–Ω—ñ"""
       try:
           user_id = update.effective_user.id
           new_name = update.message.text

           result = self.users.update_one(
               {"user_id": user_id, "active": True},
               {"$set": {"name": new_name}}
           )

           if result.modified_count > 0:
               await update.message.reply_text(f"–í–∞—à–µ —ñ–º'—è –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞: {new_name}")
           else:
               await update.message.reply_text("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ —ñ–º'—è. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.")

           return await self.change_bio(update, context)
       except Exception as e:
           logger.error(f"Error saving new name: {e}", exc_info=True)
           await update.message.reply_text("–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ —ñ–º–µ–Ω—ñ.")
           return CHANGE_BIO

   async def edit_age(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –≤—ñ–∫—É"""
       await update.message.reply_text("–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤–∏–π –≤—ñ–∫:")
       return EDIT_AGE

   async def save_age(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –≤—ñ–∫—É"""
       try:
           user_id = update.effective_user.id

           try:
               new_age = int(update.message.text)
               if new_age < 18:
                   await update.message.reply_text("–í—ñ–∫ –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ –Ω–µ –º–µ–Ω—à–µ 18 —Ä–æ–∫—ñ–≤.")
                   return EDIT_AGE
           except ValueError:
               await update.message.reply_text("–ë—É–¥—å –ª–∞—Å–∫–∞, –≤–≤–µ–¥—ñ—Ç—å —á–∏—Å–ª–æ.")
               return EDIT_AGE

           result = self.users.update_one(
               {"user_id": user_id, "active": True},
               {"$set": {"age": new_age}}
           )

           if result.modified_count > 0:
               await update.message.reply_text(f"–í–∞—à –≤—ñ–∫ –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞: {new_age}")
           else:
               await update.message.reply_text("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –≤—ñ–∫. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.")

           return await self.change_bio(update, context)
       except Exception as e:
           logger.error(f"Error saving new age: {e}", exc_info=True)
           await update.message.reply_text("–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –≤—ñ–∫—É.")
           return CHANGE_BIO

   async def edit_city(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è –º—ñ—Å—Ç–∞"""
       await update.message.reply_text("–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤–µ –º—ñ—Å—Ç–æ:")
       return EDIT_CITY

   async def save_city(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –º—ñ—Å—Ç–∞"""
       try:
           user_id = update.effective_user.id
           new_city = update.message.text

           result = self.users.update_one(
               {"user_id": user_id, "active": True},
               {"$set": {"city": new_city}}
           )

           if result.modified_count > 0:
               await update.message.reply_text(f"–í–∞—à–µ –º—ñ—Å—Ç–æ –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞: {new_city}")
           else:
               await update.message.reply_text("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –º—ñ—Å—Ç–æ. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.")

           return await self.change_bio(update, context)
       except Exception as e:
           logger.error(f"Error saving new city: {e}", exc_info=True)
           await update.message.reply_text("–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –º—ñ—Å—Ç–∞.")
           return CHANGE_BIO

   async def edit_interests(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è —ñ–Ω—Ç–µ—Ä–µ—Å—ñ–≤"""
       await update.message.reply_text("–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤–∏–π –æ–ø–∏—Å —Å–≤–æ—ó—Ö —ñ–Ω—Ç–µ—Ä–µ—Å—ñ–≤:")
       return EDIT_INTERESTS

   async def save_interests(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–æ–≤–∏—Ö —ñ–Ω—Ç–µ—Ä–µ—Å—ñ–≤"""
       try:
           user_id = update.effective_user.id
           new_interests = update.message.text

           result = self.users.update_one(
               {"user_id": user_id, "active": True},
               {"$set": {"interests": new_interests}}
           )

           if result.modified_count > 0:
               await update.message.reply_text("–û–ø–∏—Å —ñ–Ω—Ç–µ—Ä–µ—Å—ñ–≤ —É—Å–ø—ñ—à–Ω–æ –æ–Ω–æ–≤–ª–µ–Ω–æ!")
           else:
               await update.message.reply_text("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ –æ–ø–∏—Å. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.")

           return await self.change_bio(update, context)
       except Exception as e:
           logger.error(f"Error saving new interests: {e}", exc_info=True)
           await update.message.reply_text("–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –æ–ø–∏—Å—É.")
           return CHANGE_BIO

   async def edit_instagram(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–†–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è Instagram"""
       await update.message.reply_text(
           "–í–≤–µ–¥—ñ—Ç—å –Ω–æ–≤–∏–π Instagram –∞–±–æ –Ω–∞–ø–∏—à—ñ—Ç—å '–í–∏–¥–∞–ª–∏—Ç–∏', —â–æ–± –ø—Ä–∏–±—Ä–∞—Ç–∏ –π–æ–≥–æ:"
       )
       return EDIT_INSTAGRAM

   async def save_instagram(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ Instagram"""
       try:
           user_id = update.effective_user.id
           text = update.message.text

           if text.lower() == "–≤–∏–¥–∞–ª–∏—Ç–∏":
               result = self.users.update_one(
                   {"user_id": user_id, "active": True},
                   {"$unset": {"instagram": ""}}
               )

               if result.modified_count > 0:
                   await update.message.reply_text("Instagram —É—Å–ø—ñ—à–Ω–æ –≤–∏–¥–∞–ª–µ–Ω–æ –∑ –ø—Ä–æ—Ñ—ñ–ª—é.")
               else:
                   await update.message.reply_text("–ù–µ –≤–¥–∞–ª–æ—Å—è –≤–∏–¥–∞–ª–∏—Ç–∏ Instagram. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.")
           else:
               # –û—á–∏—â–∞—î–º–æ –Ω—ñ–∫ –≤—ñ–¥ @ –Ω–∞ –ø–æ—á–∞—Ç–∫—É, —è–∫—â–æ —î
               if text.startswith('@'):
                   insta_username = text[1:]
               else:
                   insta_username = text

               result = self.users.update_one(
                   {"user_id": user_id, "active": True},
                   {"$set": {"instagram": insta_username}}
               )

               if result.modified_count > 0:
                   await update.message.reply_text(f"–í–∞—à Instagram –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞: @{insta_username}")
               else:
                   await update.message.reply_text("–ù–µ –≤–¥–∞–ª–æ—Å—è –æ–Ω–æ–≤–∏—Ç–∏ Instagram. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.")

           return await self.change_bio(update, context)
       except Exception as e:
           logger.error(f"Error saving new Instagram: {e}", exc_info=True)
           await update.message.reply_text("–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ Instagram.")
           return CHANGE_BIO

   async def view_likes(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤, —è–∫—ñ –ª–∞–π–∫–Ω—É–ª–∏ –≤–∞—à –ø—Ä–æ—Ñ—ñ–ª—å"""
       user_id = update.effective_user.id

       try:
           # –û—Ç—Ä–∏–º—É—î–º–æ –ª–∞–π–∫–∏, –Ω–∞–¥—ñ—Å–ª–∞–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É
           likes_cursor = self.likes.find({
               "to_user": user_id,
               "from_user": {"$exists": True}
           }).sort("created_at", pymongo.DESCENDING)

           likes = list(likes_cursor)

           if not likes:
               await update.message.reply_text(
                   "–£ –≤–∞—Å –ø–æ–∫–∏ –Ω–µ–º–∞—î –Ω–æ–≤–∏—Ö –ª–∞–π–∫—ñ–≤. –ü—Ä–æ–¥–æ–≤–∂—É–π—Ç–µ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ç–∏—Å—è –±–æ—Ç–æ–º!"
               )

               # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –æ—Å–Ω–æ–≤–Ω—É –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É
               keyboard = [
                   [KeyboardButton("üë§ –î–∏–≤–∏—Ç–∏—Å—å –∞–Ω–∫–µ—Ç–∏")],
                   [KeyboardButton("‚ù§Ô∏è –ú–æ—ó –ª–∞–π–∫–∏")],
                   [KeyboardButton("üìù –ú–æ—ó –ø–∞—Ä–∏")],
                   [KeyboardButton("‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è")]
               ]
               reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
               await update.message.reply_text("–ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é:", reply_markup=reply_markup)
               return VIEWING_PROFILES

           # –í—ñ–¥–æ–±—Ä–∞–∂–∞—î–º–æ –ø–µ—Ä—à–∏–π –ª–∞–π–∫
           await self.show_like(update, context, likes)
           return VIEWING_PROFILES

       except Exception as e:
           logger.error(f"Error in view_likes: {e}", exc_info=True)
           await update.message.reply_text("–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≥–ª—è–¥—ñ –ª–∞–π–∫—ñ–≤.")

           # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –æ—Å–Ω–æ–≤–Ω—É –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É
           keyboard = [
               [KeyboardButton("üë§ –î–∏–≤–∏—Ç–∏—Å—å –∞–Ω–∫–µ—Ç–∏")],
               [KeyboardButton("‚ù§Ô∏è –ú–æ—ó –ª–∞–π–∫–∏")],
               [KeyboardButton("üìù –ú–æ—ó –ø–∞—Ä–∏")],
               [KeyboardButton("‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è")]
           ]
           reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
           await update.message.reply_text("–°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑:", reply_markup=reply_markup)
           return VIEWING_PROFILES

   async def show_like(self, update: Update, context: ContextTypes.DEFAULT_TYPE, likes):
       """–ü–æ–∫–∞–∑—É—î –ø—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —è–∫–∏–π –ª–∞–π–∫–Ω—É–≤ –≤–∞—à –ø—Ä–æ—Ñ—ñ–ª—å"""
       if not likes:
           # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –æ—Å–Ω–æ–≤–Ω—É –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É
           keyboard = [
               [KeyboardButton("üë§ –î–∏–≤–∏—Ç–∏—Å—å –∞–Ω–∫–µ—Ç–∏")],
               [KeyboardButton("‚ù§Ô∏è –ú–æ—ó –ª–∞–π–∫–∏")],
               [KeyboardButton("üìù –ú–æ—ó –ø–∞—Ä–∏")],
               [KeyboardButton("‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è")]
           ]
           reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
           await update.message.reply_text("–ë—ñ–ª—å—à–µ –ª–∞–π–∫—ñ–≤ –Ω–µ–º–∞—î. –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é:", reply_markup=reply_markup)
           return VIEWING_PROFILES

       # –ë–µ—Ä–µ–º–æ –ø–µ—Ä—à–∏–π –ª–∞–π–∫
       like = likes[0]
       from_user_id = like.get("from_user")

       # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ —Ä–µ—à—Ç—É –ª–∞–π–∫—ñ–≤ —É –∫–æ–Ω—Ç–µ–∫—Å—Ç—ñ –¥–ª—è –ø–æ–¥–∞–ª—å—à–æ–≥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É
       remaining_likes = likes[1:] if len(likes) > 1 else []
       context.user_data['remaining_likes'] = remaining_likes

       # –û—Ç—Ä–∏–º—É—î–º–æ –ø—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —è–∫–∏–π –ª–∞–π–∫–Ω—É–≤
       user_profile = self.users.find_one({"user_id": from_user_id, "active": True})

       if not user_profile:
           # –Ø–∫—â–æ –ø—Ä–æ—Ñ—ñ–ª—å –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –ø–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –ª–∞–π–∫—É
           if remaining_likes:
               return await self.show_like(update, context, remaining_likes)
           else:
               # –Ø–∫—â–æ –ª–∞–π–∫—ñ–≤ –±—ñ–ª—å—à–µ –Ω–µ–º–∞—î
               keyboard = [
                   [KeyboardButton("üë§ –î–∏–≤–∏—Ç–∏—Å—å –∞–Ω–∫–µ—Ç–∏")],
                   [KeyboardButton("‚ù§Ô∏è –ú–æ—ó –ª–∞–π–∫–∏")],
                   [KeyboardButton("üìù –ú–æ—ó –ø–∞—Ä–∏")],
                   [KeyboardButton("‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è")]
               ]
               reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
               await update.message.reply_text("–ë—ñ–ª—å—à–µ –ª–∞–π–∫—ñ–≤ –Ω–µ–º–∞—î. –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é:", reply_markup=reply_markup)
               return VIEWING_PROFILES

       # –§–æ—Ä–º—É—î–º–æ –ø—Ä–æ—Ñ—ñ–ª—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
       profile_text = (
           f"üë§ {user_profile.get('name', '–ù–µ–≤—ñ–¥–æ–º–∏–π')}, {user_profile.get('age', '?')}\n"
           f"üåÜ {user_profile.get('city', '–ù–µ–≤—ñ–¥–æ–º–µ –º—ñ—Å—Ç–æ')}\n"
       )

       # –î–æ–¥–∞—î–º–æ –º–µ—Ç—É –∑–Ω–∞–π–æ–º—Å—Ç–≤–∞, —è–∫—â–æ —î
       if 'purpose' in user_profile:
           profile_text += f"üéØ {user_profile['purpose']}\n\n"
       else:
           profile_text += "üéØ –ù–µ –≤–∫–∞–∑–∞–Ω–æ\n\n"

       # –î–æ–¥–∞—î–º–æ —ñ–Ω—Ç–µ—Ä–µ—Å–∏, —è–∫—â–æ —î
       if 'interests' in user_profile and user_profile['interests']:
           profile_text += f"üìù {user_profile['interests']}"
       else:
           profile_text += "üìù –ù–µ–º–∞—î —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó"

       # –î–æ–¥–∞—î–º–æ Instagram, —è–∫—â–æ —î
       if 'instagram' in user_profile and user_profile['instagram']:
           profile_text += f"\n\nüì∏ Instagram: @{user_profile['instagram']}"

       # –í—ñ–¥–º—ñ—á–∞—î–º–æ Super Like, —è–∫—â–æ –±—É–ª–æ
       if like.get("super_like"):
           profile_text += "\n\nüåü –í–∞–º –Ω–∞–¥—ñ—Å–ª–∞–ª–∏ Super Like!"

       # –î–æ–¥–∞—î–º–æ —Å—Ç–∞—Ç—É—Å –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
       if 'selfie_photo' in user_profile:
           profile_text += "\n\n‚úÖ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏–≤ —Ñ–æ—Ç–æ"
       else:
           profile_text += "\n\n‚ö†Ô∏è –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏–≤ —Ñ–æ—Ç–æ"

       # –Ü–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–∫–∏
       keyboard = [
           [
               InlineKeyboardButton("‚ù§Ô∏è –õ–∞–π–∫–Ω—É—Ç–∏ —É –≤—ñ–¥–ø–æ–≤—ñ–¥—å", callback_data=f"like_{from_user_id}"),
               InlineKeyboardButton("‚û°Ô∏è –ù–∞—Å—Ç—É–ø–Ω–∏–π", callback_data="next_like")
           ]
       ]
       reply_markup = InlineKeyboardMarkup(keyboard)

       # –í—ñ–¥–ø—Ä–∞–≤–∫–∞ —Ñ–æ—Ç–æ –∞–±–æ –≤—ñ–¥–µ–æ
       media_sent = False

       # –°–ø—Ä–æ–±–∞ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≥–æ–ª–æ–≤–Ω–µ —Ñ–æ—Ç–æ
       if 'main_photo' in user_profile and user_profile['main_photo']:
           try:
               await update.message.reply_photo(
                   user_profile['main_photo'],
                   caption=profile_text,
                   reply_markup=reply_markup
               )
               media_sent = True
           except Exception as e:
               logger.error(f"Error sending profile main photo: {e}", exc_info=True)

       # –Ø–∫—â–æ —Ñ–æ—Ç–æ –Ω–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏, –ø—Ä–æ–±—É—î–º–æ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤—ñ–¥–µ–æ
       if not media_sent and 'main_video' in user_profile and user_profile['main_video']:
           try:
               await update.message.reply_video(
                   user_profile['main_video'],
                   caption=profile_text,
                   reply_markup=reply_markup
               )
               media_sent = True
           except Exception as e:
               logger.error(f"Error sending profile main video: {e}", exc_info=True)

       # –Ø–∫—â–æ –Ω–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –Ω—ñ —Ñ–æ—Ç–æ, –Ω—ñ –≤—ñ–¥–µ–æ
       if not media_sent:
           await update.message.reply_text(
               profile_text,
               reply_markup=reply_markup
           )

       # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Ç–æ—á–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å –¥–ª—è –º–æ–∂–ª–∏–≤–æ–≥–æ –ª–∞–π–∫—É
       context.user_data['current_profile_id'] = from_user_id

       return VIEWING_PROFILES

   async def view_matches(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–í—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å–ø–∏—Å–∫—É –º–∞—Ç—á—ñ–≤"""
       try:
           user_id = update.effective_user.id

           # –û—Ç—Ä–∏–º—É—î–º–æ –º–∞—Ç—á—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
           matches_cursor = self.matches.find({
               "users": user_id,
               "active": True
           }).sort("created_at", pymongo.DESCENDING)

           matches = list(matches_cursor)

           if not matches:
               await update.message.reply_text(
                   "–£ –≤–∞—Å –ø–æ–∫–∏ –Ω–µ–º–∞—î –ø–∞—Ä. –ü—Ä–æ–¥–æ–≤–∂—É–π—Ç–µ –ª–∞–π–∫–∞—Ç–∏ –ø—Ä–æ—Ñ—ñ–ª—ñ!"
               )

               # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –æ—Å–Ω–æ–≤–Ω—É –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É
               keyboard = [
                   [KeyboardButton("üë§ –î–∏–≤–∏—Ç–∏—Å—å –∞–Ω–∫–µ—Ç–∏")],
                   [KeyboardButton("‚ù§Ô∏è –ú–æ—ó –ª–∞–π–∫–∏")],
                   [KeyboardButton("üìù –ú–æ—ó –ø–∞—Ä–∏")],
                   [KeyboardButton("‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è")]
               ]
               reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
               await update.message.reply_text("–ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é:", reply_markup=reply_markup)
               return VIEWING_PROFILES

           # –°—Ç–≤–æ—Ä—é—î–º–æ —Å–ø–∏—Å–æ–∫ –∫–Ω–æ–ø–æ–∫ –∑ –ø–∞—Ä–∞–º–∏
           match_buttons = []

           for match in matches:
               # –û—Ç—Ä–∏–º—É—î–º–æ ID —ñ–Ω—à–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –≤ –ø–∞—Ä—ñ
               other_user_id = match["users"][0] if match["users"][1] == user_id else match["users"][1]

               # –û—Ç—Ä–∏–º—É—î–º–æ –ø—Ä–æ—Ñ—ñ–ª—å —ñ–Ω—à–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
               other_user = self.users.find_one({"user_id": other_user_id, "active": True})

               if other_user:
                   button_text = f"{other_user.get('name', '–ù–µ–≤—ñ–¥–æ–º–∏–π')}, {other_user.get('age', '?')}"
                   match_buttons.append([KeyboardButton(button_text)])

                   # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ ID –ø—Ä–æ—Ñ—ñ–ª—é –¥–ª—è –ø–æ–¥–∞–ª—å—à–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è
                   context.user_data[f"match_{button_text}"] = other_user_id

           # –î–æ–¥–∞—î–º–æ –∫–Ω–æ–ø–∫—É –ø–æ–≤–µ—Ä–Ω–µ–Ω–Ω—è
           match_buttons.append([KeyboardButton("üîô –ù–∞–∑–∞–¥")])

           reply_markup = ReplyKeyboardMarkup(match_buttons, resize_keyboard=True)

           await update.message.reply_text(
               "–í–∞—à—ñ –ø–∞—Ä–∏. –í–∏–±–µ—Ä—ñ—Ç—å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É:",
               reply_markup=reply_markup
           )

           return VIEWING_PROFILES
       except Exception as e:
           logger.error(f"Error in view_matches: {e}", exc_info=True)
           await update.message.reply_text("–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≥–ª—è–¥—ñ –ø–∞—Ä.")

           # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –æ—Å–Ω–æ–≤–Ω—É –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É
           keyboard = [
               [KeyboardButton("üë§ –î–∏–≤–∏—Ç–∏—Å—å –∞–Ω–∫–µ—Ç–∏")],
               [KeyboardButton("‚ù§Ô∏è –ú–æ—ó –ª–∞–π–∫–∏")],
               [KeyboardButton("üìù –ú–æ—ó –ø–∞—Ä–∏")],
               [KeyboardButton("‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è")]
           ]
           reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
           await update.message.reply_text("–°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑:", reply_markup=reply_markup)
           return VIEWING_PROFILES

   async def handle_view_profiles(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–æ–±–∫–∞ –ø–µ—Ä–µ–≥–ª—è–¥—É –ø—Ä–æ—Ñ—ñ–ª—ñ–≤ –∑ InlineKeyboardMarkup –∑–∞–º—ñ—Å—Ç—å ReplyKeyboardMarkup"""
       user_id = update.effective_user.id
       try:
           # –°–ø–æ—á–∞—Ç–∫—É –ø–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ —î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –≤ –±–∞–∑—ñ
           user = self.users.find_one({"user_id": user_id, "active": True})
           if not user:
               await update.message.reply_text("–ë—É–¥—å –ª–∞—Å–∫–∞, —Å–ø–æ—á–∞—Ç–∫—É –∑–∞–≤–µ—Ä—à—ñ—Ç—å —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é.")
               return VIEWING_PROFILES

           # –õ–æ–≥—É–≤–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—É –¥–ª—è –¥—ñ–∞–≥–Ω–æ—Å—Ç–∏–∫–∏
           logger.info(f"Looking for profiles for user {user_id} with purpose: {user.get('purpose', 'Not specified')}")

           # –û—Ç—Ä–∏–º—É—î–º–æ —Å–ø–∏—Å–æ–∫ ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤, —è–∫–∏—Ö –≤–∂–µ –ª–∞–π–∫–Ω—É–ª–∏
           liked_users_cursor = self.likes.find({"from_user": user_id})
           viewed_profiles = [like['to_user'] for like in liked_users_cursor]
           viewed_profiles.append(user_id)  # –î–æ–¥–∞—î–º–æ –≤–ª–∞—Å–Ω–∏–π ID

           # –ü–æ–±—É–¥–æ–≤–∞ –±–∞–∑–æ–≤–æ–≥–æ –∑–∞–ø–∏—Ç—É - –ª–∏—à–µ –∞–∫—Ç–∏–≤–Ω—ñ –ø—Ä–æ—Ñ—ñ–ª—ñ
           base_query = {
               "user_id": {"$nin": viewed_profiles},
               "active": True,  # –õ–∏—à–µ –∞–∫—Ç–∏–≤–Ω—ñ –ø—Ä–æ—Ñ—ñ–ª—ñ
               "name": {"$exists": True},
               "age": {"$exists": True}
           }

           # –î–æ–¥–∞—î–º–æ —Ñ—ñ–ª—å—Ç—Ä–∞—Ü—ñ—é –∑–∞ –º–µ—Ç–æ—é –∑–Ω–∞–π–æ–º—Å—Ç–≤–∞ —Ç–∞ —Å—Ç–∞—Ç—Ç—é
           if user.get('purpose') == "–°—Ç–æ—Å—É–Ω–∫–∏" and user.get('looking_for') != "–í—Å—ñ":
               base_query["gender"] = user.get('looking_for')
           elif user.get('purpose') == "–î—Ä—É–∂–±–∞":
               # –î–ª—è –¥—Ä—É–∂–±–∏ –ø–æ–∫–∞–∑—É—î–º–æ —Ç—ñ–ª—å–∫–∏ —Ç–∏—Ö, —Ö—Ç–æ —Ç–µ–∂ —à—É–∫–∞—î –¥—Ä—É–∂–±—É
               base_query["purpose"] = "–î—Ä—É–∂–±–∞"

           # –î–æ–¥–∞—î–º–æ —Ñ—ñ–ª—å—Ç—Ä –∑–∞ –≤—ñ–∫–æ–≤–∏–º –¥—ñ–∞–ø–∞–∑–æ–Ω–æ–º, —è–∫—â–æ –≤—ñ–Ω –≤–∫–∞–∑–∞–Ω–∏–π
           if 'age_range' in user:
               min_age = user['age_range'].get('min', 18)
               max_age = user['age_range'].get('max', 100)
               base_query["age"] = {"$gte": min_age, "$lte": max_age}

           # –ü—Ä—ñ–æ—Ä–∏—Ç–µ—Ç–Ω–∏–π –ø–æ—à—É–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –∑ –±—É—Å—Ç-—Å—Ç–∞—Ç—É—Å–æ–º, —è–∫—â–æ —Ç–∞–∫—ñ —î
           boosted_query = base_query.copy()
           boosted_query["boosted"] = True
           boosted_match = self.users.find_one(boosted_query)

           if boosted_match:
               potential_match = boosted_match
               logger.info(f"Found boosted profile: {potential_match.get('name', 'Unknown')}")
           else:
               # –ü–æ—à—É–∫ –∑–≤–∏—á–∞–π–Ω–æ–≥–æ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ–≥–æ –º–∞—Ç—á—É
               potential_match = self.users.find_one(base_query)

           # –Ø–∫—â–æ –Ω–µ –∑–Ω–∞–π—à–ª–∏, —Å–ø—Ä–æ–±—É—î–º–æ —Å–ø—Ä–æ—Å—Ç–∏—Ç–∏ —É–º–æ–≤–∏ –ø–æ—à—É–∫—É
           if not potential_match:
               logger.info("No profiles found with full criteria, simplifying search...")
               # –ó–∞–ª–∏—à–∞—î–º–æ —Ç—ñ–ª—å–∫–∏ –±–∞–∑–æ–≤—ñ —É–º–æ–≤–∏ —ñ –≤–∏–¥–∞–ª—è—î–º–æ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ—ñ–ª—å—Ç—Ä–∏
               simplified_query = {
                   "user_id": {"$nin": viewed_profiles},
                   "active": True,  # –í—Å–µ –æ–¥–Ω–æ —à—É–∫–∞—î–º–æ –ª–∏—à–µ –∞–∫—Ç–∏–≤–Ω—ñ –ø—Ä–æ—Ñ—ñ–ª—ñ
                   "name": {"$exists": True}
               }
               potential_match = self.users.find_one(simplified_query)

           # –Ø–∫—â–æ –≤—Å–µ —â–µ –Ω–µ –∑–Ω–∞–π—à–ª–∏, —Å–ø—Ä–æ–±—É—î–º–æ –∑–Ω–∞–π—Ç–∏ –±—É–¥—å-—è–∫–∏–π –∞–∫—Ç–∏–≤–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å
           if not potential_match:
               logger.info("No profiles found with basic criteria, searching any active user...")
               potential_match = self.users.find_one({
                   "user_id": {"$ne": user_id},
                   "active": True
               })

           # –Ø–∫—â–æ –≤—Å–µ —â–µ –Ω–µ–º–∞—î –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏—Ö –ø—Ä–æ—Ñ—ñ–ª—ñ–≤
           if not potential_match:
               logger.info("No profiles found at all")
               await update.message.reply_text(
                   "–ù–∞ –∂–∞–ª—å, –∑–∞—Ä–∞–∑ –Ω–µ–º–∞—î –Ω–æ–≤–∏—Ö –ø—Ä–æ—Ñ—ñ–ª—ñ–≤ –¥–ª—è –ø–µ—Ä–µ–≥–ª—è–¥—É. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ!"
               )

               # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É
               keyboard = [
                   [KeyboardButton("üë§ –î–∏–≤–∏—Ç–∏—Å—å –∞–Ω–∫–µ—Ç–∏")],
                   [KeyboardButton("‚ù§Ô∏è –ú–æ—ó –ª–∞–π–∫–∏")],
                   [KeyboardButton("üìù –ú–æ—ó –ø–∞—Ä–∏")],
                   [KeyboardButton("‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è")]
               ]
               reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
               await update.message.reply_text("–ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é:", reply_markup=reply_markup)

               return VIEWING_PROFILES

           # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ —á–∏ –º–∞—î –ø—Ä–æ—Ñ—ñ–ª—å –≤—Å—ñ –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ –ø–æ–ª—è
           if 'user_id' not in potential_match:
               logger.warning(f"Found profile without user_id field: {potential_match}")
               await update.message.reply_text(
                   "–ù–∞ –∂–∞–ª—å, –≤–∏–Ω–∏–∫–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞ –∑ –∞–Ω–∫–µ—Ç–æ—é. –°–ø—Ä–æ–±—É–π—Ç–µ –ø—ñ–∑–Ω—ñ—à–µ!"
               )
               return VIEWING_PROFILES

           logger.info(f"Found potential match: {potential_match.get('name', 'Unknown')}")

           # –§–æ—Ä–º—É—î–º–æ –ø—Ä–æ—Ñ—ñ–ª—å –∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é –Ω–∞ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –ø–æ–ª—ñ–≤
           profile_text = (
               f"üë§ {potential_match.get('name', '–ù–µ–≤—ñ–¥–æ–º–∏–π')}, {potential_match.get('age', '?')}\n"
               f"üåÜ {potential_match.get('city', '–ù–µ–≤—ñ–¥–æ–º–µ –º—ñ—Å—Ç–æ')}\n"
           )

           # –î–æ–¥–∞—î–º–æ –º–µ—Ç—É, —è–∫—â–æ —î
           if 'purpose' in potential_match:
               profile_text += f"üéØ {potential_match['purpose']}\n\n"
           else:
               profile_text += f"üéØ –ù–µ –≤–∫–∞–∑–∞–Ω–æ\n\n"

           # –î–æ–¥–∞—î–º–æ —ñ–Ω—Ç–µ—Ä–µ—Å–∏, —è–∫—â–æ —î
           if 'interests' in potential_match and potential_match['interests']:
               profile_text += f"üìù {potential_match['interests']}"
           else:
               profile_text += "üìù –ù–µ–º–∞—î —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó"

           # –î–æ–¥–∞—î–º–æ Instagram, —è–∫—â–æ —î
           if 'instagram' in potential_match and potential_match['instagram']:
               profile_text += f"\n\nüì∏ Instagram: @{potential_match['instagram']}"

           # –î–æ–¥–∞—î–º–æ —Å—Ç–∞—Ç—É—Å –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—ó
           if 'selfie_photo' in potential_match:
               profile_text += "\n\n‚úÖ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏–≤ —Ñ–æ—Ç–æ"
           else:
               profile_text += "\n\n‚ö†Ô∏è –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏–≤ —Ñ–æ—Ç–æ"

           # –î–æ–¥–∞—î–º–æ —Å—Ç–∞—Ç—É—Å Web3 –≥–∞–º–∞–Ω—Ü—è
           if potential_match.get('wallet_verified'):
               profile_text += "\nüîπ –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –ø—ñ–¥—Ç–≤–µ—Ä–¥–∏–≤ Web3 –≥–∞–º–∞–Ω–µ—Ü—å"

           # –î–æ–¥–∞—î–º–æ —Å—Ç–∞—Ç—É—Å –±—É—Å—Ç—É, —è–∫—â–æ —î
           if potential_match.get('boosted'):
               profile_text += "\nüöÄ –ü–æ–ø—É–ª—è—Ä–Ω–∏–π –ø—Ä–æ—Ñ—ñ–ª—å"

           # –ü—Ä–∏–±–∏—Ä–∞—î–º–æ –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É –ø–µ—Ä–µ–¥ –ø–æ–∫–∞–∑–æ–º –∞–Ω–∫–µ—Ç–∏
           await update.message.reply_text(
               "–ó–Ω–∞–π–¥–µ–Ω–æ –∞–Ω–∫–µ—Ç—É:",
               reply_markup=ReplyKeyboardRemove()
           )

           # –í—ñ–¥–ø—Ä–∞–≤–∫–∞ –º–µ–¥—ñ–∞ –∑ –ø–µ—Ä–µ–≤—ñ—Ä–∫–æ—é –Ω–∞ –ø–æ–º–∏–ª–∫–∏
           media_sent = False

           # –°–ø—Ä–æ–±–∞ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≥–æ–ª–æ–≤–Ω–µ —Ñ–æ—Ç–æ
           if 'main_photo' in potential_match and potential_match['main_photo']:
               try:
                   await update.message.reply_photo(
                       potential_match['main_photo'],
                       caption=profile_text
                   )
                   media_sent = True
               except Exception as e:
                   logger.error(f"Error sending profile main photo: {e}", exc_info=True)

           # –Ø–∫—â–æ —Ñ–æ—Ç–æ –Ω–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏, –ø—Ä–æ–±—É—î–º–æ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –≤—ñ–¥–µ–æ
           if not media_sent and 'main_video' in potential_match and potential_match['main_video']:
               try:
                   await update.message.reply_video(
                       potential_match['main_video'],
                       caption=profile_text
                   )
                   media_sent = True
               except Exception as e:
                   logger.error(f"Error sending profile main video: {e}", exc_info=True)

           # –Ø–∫—â–æ –Ω–µ –≤–¥–∞–ª–æ—Å—è –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –Ω—ñ —Ñ–æ—Ç–æ, –Ω—ñ –≤—ñ–¥–µ–æ
           if not media_sent:
               await update.message.reply_text(profile_text)

           # –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ —Ñ–æ—Ç–æ, —è–∫—â–æ —î
           if 'additional_photos' in potential_match and potential_match['additional_photos']:
               media_group = []

               for photo_id in potential_match['additional_photos']:
                   try:
                       if photo_id:  # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ ID –Ω–µ –ø—É—Å—Ç–∏–π
                           media_group.append(InputMediaPhoto(photo_id))
                   except Exception as e:
                       logger.error(f"Error adding photo to media group: {e}", exc_info=True)

               if media_group:
                   try:
                       await update.message.reply_media_group(media_group)
                   except Exception as e:
                       logger.error(f"Error sending media group: {e}", exc_info=True)

           # –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –≤—ñ–¥–µ–æ –æ–∫—Ä–µ–º–æ, —è–∫—â–æ —î
           if 'additional_videos' in potential_match and potential_match['additional_videos']:
               for video_id in potential_match['additional_videos']:
                   try:
                       if video_id:  # –ü–µ—Ä–µ–≤—ñ—Ä—è—î–º–æ, —â–æ ID –Ω–µ –ø—É—Å—Ç–∏–π
                           await update.message.reply_video(video_id)
                   except Exception as e:
                       logger.error(f"Error sending additional video: {e}", exc_info=True)

           # –ó–∞–º—ñ–Ω—é—î–º–æ –∑–≤–∏—á–∞–π–Ω—ñ –∫–Ω–æ–ø–∫–∏ –Ω–∞ —ñ–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏ (–ø—ñ–¥ –∞–Ω–∫–µ—Ç–æ—é)
           # –î–æ–¥–∞—î–º–æ –∫–Ω–æ–ø–∫—É Super Like, —è–∫—â–æ —î –≥–∞–º–∞–Ω–µ—Ü—å
           keyboard = []

           # –û—Å–Ω–æ–≤–Ω–∏–π —Ä—è–¥ –∫–Ω–æ–ø–æ–∫
           first_row = [
               InlineKeyboardButton("‚ù§Ô∏è", callback_data=f"like_{potential_match['user_id']}"),
               InlineKeyboardButton("üíå", callback_data=f"message_{potential_match['user_id']}"),
               InlineKeyboardButton("‚û°Ô∏è", callback_data="next")
           ]
           keyboard.append(first_row)

           # –î–æ–¥–∞—î–º–æ —Ä—è–¥ –∑ Super Like, —è–∫—â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–∞—î –≥–∞–º–∞–Ω–µ—Ü—å —ñ tokens
           user_has_wallet = user.get('wallet_verified', False)
           token_balance = user.get('token_balance', 0)

           if user_has_wallet and token_balance >= 30:  # –í–∞—Ä—Ç—ñ—Å—Ç—å Super Like = 30 —Ç–æ–∫–µ–Ω—ñ–≤
               keyboard.append([
                   InlineKeyboardButton("üåü Super Like (30 —Ç–æ–∫–µ–Ω—ñ–≤)", callback_data=f"superlike_{potential_match['user_id']}")
               ])

           reply_markup = InlineKeyboardMarkup(keyboard)

           # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ ID –ø–æ—Ç–æ—á–Ω–æ–≥–æ –ø—Ä–æ—Ñ—ñ–ª—é –≤ context
           context.user_data['current_profile_id'] = potential_match['user_id']

           # –í—ñ–¥–ø—Ä–∞–≤–ª—è—î–º–æ —ñ–Ω–ª–∞–π–Ω-–∫–Ω–æ–ø–∫–∏ –∑ –¥—ñ—î—é
           await update.message.reply_text(
               "–û–±–µ—Ä—ñ—Ç—å –¥—ñ—é:",
               reply_markup=reply_markup
           )

       except Exception as e:
           logger.error(f"Error viewing profiles: {e}", exc_info=True)
           await update.message.reply_text("–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –ø–µ—Ä–µ–≥–ª—è–¥—ñ –ø—Ä–æ—Ñ—ñ–ª—ñ–≤.")

           # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –æ—Å–Ω–æ–≤–Ω—É –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É
           keyboard = [
               [KeyboardButton("üë§ –î–∏–≤–∏—Ç–∏—Å—å –∞–Ω–∫–µ—Ç–∏")],
               [KeyboardButton("‚ù§Ô∏è –ú–æ—ó –ª–∞–π–∫–∏")],
               [KeyboardButton("üìù –ú–æ—ó –ø–∞—Ä–∏")],
               [KeyboardButton("‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è")]
           ]
           reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
           await update.message.reply_text("–°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑:", reply_markup=reply_markup)

       return VIEWING_PROFILES

   async def handle_callback_query(self, update: Update, context: ContextTypes.DEFAULT_TYPE):
       """–û–±—Ä–æ–±–∫–∞ callback-–∑–∞–ø–∏—Ç—ñ–≤ –≤—ñ–¥ —ñ–Ω–ª–∞–π–Ω –∫–Ω–æ–ø–æ–∫"""
       query = update.callback_query

       try:
           # –ù–∞–¥—Å–∏–ª–∞—î–º–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –Ω–∞ callback, —â–æ–± –ø—Ä–∏–±—Ä–∞—Ç–∏ "–≥–æ–¥–∏–Ω–Ω–∏–∫ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è"
           await query.answer()

           if query.data == "view_matches":
               # –ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É –º–∞—Ç—á—ñ–≤
               await query.message.reply_text("–ü–µ—Ä–µ—Ö–æ–¥–∏–º–æ –¥–æ –≤–∞—à–∏—Ö –ø–∞—Ä...")
               return await self.view_matches(update, context)

           elif query.data.startswith('like_'):
               user_id = int(query.data.split('_')[1])
               # –û—Ç—Ä–∏–º—É—î–º–æ ID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —è–∫–æ–º—É —Å—Ç–∞–≤–∏–º–æ –ª–∞–π–∫
               success, message = await self.like_system.create_like(
                   query.from_user.id,
                   user_id
               )
               # –ü–æ–≤—ñ–¥–æ–º–ª—è—î–º–æ –ø—Ä–æ —Ä–µ–∑—É–ª—å—Ç–∞—Ç
               await query.message.reply_text(message)

               # –ü–æ–∫–∞–∑—É—î–º–æ –Ω–∞—Å—Ç—É–ø–Ω—É –∞–Ω–∫–µ—Ç—É –∞–±–æ –ø–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é
               if "–≤–∑–∞—î–º–Ω–∏–π –ª–∞–π–∫" in message:
                   # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –≤ –≥–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é –ø—ñ—Å–ª—è –≤–∑–∞—î–º–Ω–æ–≥–æ –ª–∞–π–∫—É
                   keyboard = [
                       [KeyboardButton("üë§ –î–∏–≤–∏—Ç–∏—Å—å –∞–Ω–∫–µ—Ç–∏")],
                       [KeyboardButton("‚ù§Ô∏è –ú–æ—ó –ª–∞–π–∫–∏")],
                       [KeyboardButton("üìù –ú–æ—ó –ø–∞—Ä–∏")],
                       [KeyboardButton("‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è")]
                   ]
                   reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
                   await query.message.reply_text("–ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é:", reply_markup=reply_markup)
                   return VIEWING_PROFILES
               else:
                   # –ü–æ–∫–∞–∑—É—î–º–æ –Ω–∞—Å—Ç—É–ø–Ω—É –∞–Ω–∫–µ—Ç—É –ø—ñ—Å–ª—è –∑–≤–∏—á–∞–π–Ω–æ–≥–æ –ª–∞–π–∫—É
                   return await self.handle_view_profiles(update, context)

           elif query.data.startswith('message_'):
               user_id = int(query.data.split('_')[1])
               user = self.users.find_one({"user_id": user_id, "active": True})

               if user and 'username' in user and user['username']:
                   username = user['username']
                   message = f"–í–∏ –º–æ–∂–µ—Ç–µ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—É @{username}"
                   await query.message.reply_text(message)
               else:
                   await query.message.reply_text(
                       "–ù–∞ –∂–∞–ª—å, —É —Ü—å–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ–º–∞—î –¥–æ—Å—Ç—É–ø–Ω–æ–≥–æ username –≤ Telegram."
                   )

               # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é
               keyboard = [
                   [KeyboardButton("üë§ –î–∏–≤–∏—Ç–∏—Å—å –∞–Ω–∫–µ—Ç–∏")],
                   [KeyboardButton("‚ù§Ô∏è –ú–æ—ó –ª–∞–π–∫–∏")],
                   [KeyboardButton("üìù –ú–æ—ó –ø–∞—Ä–∏")],
                   [KeyboardButton("‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è")]
               ]
               reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
               await query.message.reply_text("–ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é:", reply_markup=reply_markup)
               return VIEWING_PROFILES

           elif query.data == "next":
               # –ü–æ–∫–∞–∑—É—î–º–æ –Ω–∞—Å—Ç—É–ø–Ω—É –∞–Ω–∫–µ—Ç—É
               return await self.handle_view_profiles(update, context)

           elif query.data.startswith('superlike_'):
               # –û–±—Ä–æ–±–∫–∞ Super Like —á–µ—Ä–µ–∑ Web3
               user_id = query.from_user.id
               to_user_id = int(query.data.split('_')[1])

               # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ ID –¥–ª—è Super Like
               context.user_data['current_profile_id'] = to_user_id

               # –í–∏–∫–ª–∏–∫–∞—î–º–æ –º–µ—Ç–æ–¥ Super Like
               return await self.super_like(update, context)

           elif query.data == "next_like":
               # –û—Ç—Ä–∏–º—É—î–º–æ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –ª–∞–π–∫ –∑ –∫–æ–Ω—Ç–µ–∫—Å—Ç—É
               remaining_likes = context.user_data.get('remaining_likes', [])
               if remaining_likes:
                   return await self.show_like(update, context, remaining_likes)
               else:
                   # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –¥–æ —Å–ø–∏—Å–∫—É –ª–∞–π–∫—ñ–≤ –∞–±–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é
                   keyboard = [
                       [KeyboardButton("üë§ –î–∏–≤–∏—Ç–∏—Å—å –∞–Ω–∫–µ—Ç–∏")],
                       [KeyboardButton("‚ù§Ô∏è –ú–æ—ó –ª–∞–π–∫–∏")],
                       [KeyboardButton("üìù –ú–æ—ó –ø–∞—Ä–∏")],
                       [KeyboardButton("‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è")]
                   ]
                   reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
                   await query.message.reply_text("–ë—ñ–ª—å—à–µ –ª–∞–π–∫—ñ–≤ –Ω–µ–º–∞—î. –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ—Å—è –¥–æ –≥–æ–ª–æ–≤–Ω–æ–≥–æ –º–µ–Ω—é:", reply_markup=reply_markup)
                   return VIEWING_PROFILES

           else:
               # –ù–µ–≤—ñ–¥–æ–º–∏–π callback
               keyboard = [
                   [KeyboardButton("üë§ –î–∏–≤–∏—Ç–∏—Å—å –∞–Ω–∫–µ—Ç–∏")],
                   [KeyboardButton("‚ù§Ô∏è –ú–æ—ó –ª–∞–π–∫–∏")],
                   [KeyboardButton("üìù –ú–æ—ó –ø–∞—Ä–∏")],
                   [KeyboardButton("‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è")]
               ]
               reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)
               await query.message.reply_text("–ì–æ–ª–æ–≤–Ω–µ –º–µ–Ω—é:", reply_markup=reply_markup)
               return VIEWING_PROFILES

       except Exception as e:
           logger.error(f"General error in handle_callback_query: {e}", exc_info=True)
           try:
               # –ü–æ–≤–µ—Ä—Ç–∞—î–º–æ –æ—Å–Ω–æ–≤–Ω—É –∫–ª–∞–≤—ñ–∞—Ç—É—Ä—É —É –≤–∏–ø–∞–¥–∫—É –ø–æ–º–∏–ª–∫–∏
               keyboard = [
                   [KeyboardButton("üë§ –î–∏–≤–∏—Ç–∏—Å—å –∞–Ω–∫–µ—Ç–∏")],
                   [KeyboardButton("‚ù§Ô∏è –ú–æ—ó –ª–∞–π–∫–∏")],
                   [KeyboardButton("üìù –ú–æ—ó –ø–∞—Ä–∏")],
                   [KeyboardButton("‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è")]
               ]
               reply_markup = ReplyKeyboardMarkup(keyboard, resize_keyboard=True)

               await query.message.reply_text(
                   "–í–∏–Ω–∏–∫–ª–∞ –ø–æ–º–∏–ª–∫–∞. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑:",
                   reply_markup=reply_markup
               )
           except Exception:
               pass  # –Ø–∫—â–æ –Ω–∞–≤—ñ—Ç—å —Ü–µ –Ω–µ —Å–ø—Ä–∞—Ü—é–≤–∞–ª–æ, –ø—Ä–æ—Å—Ç–æ —ñ–≥–Ω–æ—Ä—É—î–º–æ
           return VIEWING_PROFILES

###########################################
# Part 6: Main Code
###########################################

def main():
   """–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –∑ Web3 —ñ–Ω—Ç–µ–≥—Ä–∞—Ü—ñ—î—é"""
   print("–ü–æ—á–∞—Ç–æ–∫ —Ñ—É–Ω–∫—Ü—ñ—ó main()")
   bot_handler = None
   mongodb_client = None

   try:
       # –û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ö–µ–º–∏ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö –¥–ª—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ Web3
       print("–û–Ω–æ–≤–ª–µ–Ω–Ω—è —Å—Ö–µ–º–∏ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö...")
       users_success, users_message = update_user_schema()
       matches_success, matches_message = update_match_schema()

       print(f"–û–Ω–æ–≤–ª–µ–Ω–Ω—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤: {users_success}, {users_message}")
       print(f"–û–Ω–æ–≤–ª–µ–Ω–Ω—è –º–∞—Ç—á—ñ–≤: {matches_success}, {matches_message}")

       if users_success and matches_success:
           logger.info("Database schema updated successfully")
       else:
           logger.warning("Database schema update issues detected. Proceeding anyway.")

       # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–±'—î–∫—Ç–∞ –∑–∞–ø–∏—Ç—É –∑ –ø–æ—Ç—Ä—ñ–±–Ω–∏–º–∏ —Ç–∞–π–º–∞—É—Ç–∞–º–∏
       print("–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –∑–∞–ø–∏—Ç—É...")
       request = HTTPXRequest(
           connect_timeout=30.0,
           read_timeout=30.0,
           write_timeout=30.0
       )

       # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –µ–∫–∑–µ–º–ø–ª—è—Ä–∞ –±–æ—Ç–∞
       print("–°—Ç–≤–æ—Ä–µ–Ω–Ω—è –±–æ—Ç–∞...")
       bot_handler = DatingBot(TELEGRAM_TOKEN, MONGODB_URL)
       mongodb_client = bot_handler.client  # –ó–±–µ—Ä—ñ–≥–∞—î–º–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è –Ω–∞ –∫–ª—ñ—î–Ω—Ç

       # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è application –∑ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º–∏
       application = Application.builder().token(TELEGRAM_TOKEN).request(request).build()

       # –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –µ–∫–∑–µ–º–ø–ª—è—Ä –±–æ—Ç–∞ –¥–ª—è LikeSystem
       bot_handler.set_bot(application.bot)

       # –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–±—Ä–æ–±–Ω–∏–∫–∞ —Ä–æ–∑–º–æ–≤–∏ –∑ –¥–æ–¥–∞–≤–∞–Ω–Ω—è–º Web3 —Å—Ç–∞–Ω—ñ–≤
       print("–°—Ç–≤–æ—Ä–µ–Ω–Ω—è ConversationHandler...")
       conv_handler = ConversationHandler(
           entry_points=[CommandHandler('start', bot_handler.start)],
           states={
               WALLET_VERIFICATION: [
                   CallbackQueryHandler(bot_handler.handle_wallet_callback)
               ],
               WALLET_ADDRESS: [
                   MessageHandler(filters.TEXT & ~filters.COMMAND, bot_handler.handle_wallet_address),
                   CallbackQueryHandler(bot_handler.handle_wallet_callback)
               ],
               WALLET_SIGNATURE: [
                   MessageHandler(filters.TEXT & ~filters.COMMAND, bot_handler.verify_transaction)
               ],
               GENDER: [MessageHandler(filters.TEXT & ~filters.COMMAND, bot_handler.gender)],
               PURPOSE: [MessageHandler(filters.TEXT & ~filters.COMMAND, bot_handler.purpose)],
               NAME: [MessageHandler(filters.TEXT & ~filters.COMMAND, bot_handler.name)],
               AGE: [MessageHandler(filters.TEXT & ~filters.COMMAND, bot_handler.age)],
               AGE_RANGE: [MessageHandler(filters.TEXT & ~filters.COMMAND, bot_handler.age_range)],
               CITY: [MessageHandler(filters.TEXT & ~filters.COMMAND, bot_handler.city)],
               INTERESTS: [MessageHandler(filters.TEXT & ~filters.COMMAND, bot_handler.interests)],
               INSTAGRAM: [MessageHandler(filters.TEXT & ~filters.COMMAND, bot_handler.instagram)],
               MAIN_PHOTO: [
                   MessageHandler(filters.TEXT & ~filters.COMMAND, bot_handler.choose_media_type),
                   MessageHandler(filters.PHOTO, bot_handler.main_photo),
                   MessageHandler(filters.VIDEO, bot_handler.main_video)
               ],
               SELFIE_PHOTO: [
                   MessageHandler(filters.PHOTO, bot_handler.selfie_photo),
                   MessageHandler(filters.Regex('^–ü—Ä–æ–ø—É—Å—Ç–∏—Ç–∏ –≤–µ—Ä–∏—Ñ—ñ–∫–∞—Ü—ñ—é$'), bot_handler.skip_selfie)
               ],
               ADDITIONAL_PHOTO: [
                   MessageHandler(filters.PHOTO, bot_handler.additional_photo),
                   MessageHandler(filters.VIDEO, bot_handler.additional_video),
                   MessageHandler(filters.TEXT & ~filters.COMMAND, bot_handler.handle_additional_photo_choice)
               ],
               VIEWING_PROFILES: [
                   MessageHandler(filters.Regex('^üë§ –î–∏–≤–∏—Ç–∏—Å—å –∞–Ω–∫–µ—Ç–∏$'), bot_handler.handle_view_profiles),
                   MessageHandler(filters.Regex('^‚ù§Ô∏è –ú–æ—ó –ª–∞–π–∫–∏$'), bot_handler.view_likes),
                   MessageHandler(filters.Regex('^üìù –ú–æ—ó –ø–∞—Ä–∏$'), bot_handler.view_matches),
                   MessageHandler(filters.Regex('^‚öôÔ∏è –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è$'), bot_handler.settings)
               ],
               SETTINGS: [
                   MessageHandler(filters.Regex('^üíé –ü—Ä–µ–º—ñ—É–º –∞–∫–∞—É–Ω—Ç$'), bot_handler.handle_premium_account),
                   MessageHandler(filters.Regex('^üöÄ –ë—É—Å—Ç –∞–∫–∞—É–Ω—Ç—É$'), bot_handler.boost_profile),
                   MessageHandler(filters.Regex('^üí∞ –ú—ñ–π –≥–∞–º–∞–Ω–µ—Ü—å$'), bot_handler.wallet_settings),
                   MessageHandler(filters.Regex('^üë§ –ú–æ—è –∞–Ω–∫–µ—Ç–∞$'), bot_handler.show_my_profile),
                   MessageHandler(filters.Regex('^üóëÔ∏è –í–∏–¥–∞–ª–∏—Ç–∏ –∞–Ω–∫–µ—Ç—É$'), bot_handler.confirm_delete_profile),
                   MessageHandler(filters.Regex('^üîô –ù–∞–∑–∞–¥$'), bot_handler.back_to_main_menu)
               ],
               MY_PROFILE: [
                   MessageHandler(filters.Regex('^üîÑ –ó–∞–ø–æ–≤–Ω–∏—Ç–∏ –∞–Ω–∫–µ—Ç—É –Ω–∞–Ω–æ–≤–æ$'), bot_handler.confirm_restart_profile),
                   MessageHandler(filters.Regex('^üì∏ –ó–º—ñ–Ω–∏—Ç–∏ —Ñ–æ—Ç–æ/–≤—ñ–¥–µ–æ$'), bot_handler.change_profile_photo),
                   MessageHandler(filters.Regex('^‚úèÔ∏è –ó–º—ñ–Ω–∏—Ç–∏ —Ç–µ–∫—Å—Ç –∞–Ω–∫–µ—Ç–∏$'), bot_handler.change_bio),
                   MessageHandler(filters.Regex('^üîô –ù–∞–∑–∞–¥$'), bot_handler.settings)
               ],
               CONFIRM_RESTART: [
                   MessageHandler(filters.TEXT & ~filters.COMMAND, bot_handler.handle_restart_confirmation)
               ],
               CONFIRM_DELETE: [
                   MessageHandler(filters.TEXT & ~filters.COMMAND, bot_handler.handle_delete_confirmation)
               ],
               CHANGE_PHOTO: [
                   MessageHandler(filters.TEXT & ~filters.COMMAND, bot_handler.handle_change_photo_choice),
                   MessageHandler(filters.PHOTO, bot_handler.update_profile_photo),
                   MessageHandler(filters.VIDEO, bot_handler.update_profile_video)
               ],
               CHANGE_BIO: [
                   MessageHandler(filters.Regex('^–ó–º—ñ–Ω–∏—Ç–∏ —ñ–º\'—è$'), bot_handler.edit_name),
                   MessageHandler(filters.Regex('^–ó–º—ñ–Ω–∏—Ç–∏ –≤—ñ–∫$'), bot_handler.edit_age),
                   MessageHandler(filters.Regex('^–ó–º—ñ–Ω–∏—Ç–∏ –º—ñ—Å—Ç–æ$'), bot_handler.edit_city),
                   MessageHandler(filters.Regex('^–ó–º—ñ–Ω–∏—Ç–∏ –æ–ø–∏—Å$'), bot_handler.edit_interests),
                   MessageHandler(filters.Regex('^–ó–º—ñ–Ω–∏—Ç–∏ Instagram$'), bot_handler.edit_instagram),
                   MessageHandler(filters.Regex('^üîô –ù–∞–∑–∞–¥$'), bot_handler.show_my_profile)
               ],
               EDIT_NAME: [
                   MessageHandler(filters.TEXT & ~filters.COMMAND, bot_handler.save_name)
               ],
               EDIT_AGE: [
                   MessageHandler(filters.TEXT & ~filters.COMMAND, bot_handler.save_age)
               ],
               EDIT_CITY: [
                   MessageHandler(filters.TEXT & ~filters.COMMAND, bot_handler.save_city)
               ],
               EDIT_INTERESTS: [
                   MessageHandler(filters.TEXT & ~filters.COMMAND, bot_handler.save_interests)
               ],
               EDIT_INSTAGRAM: [
                   MessageHandler(filters.TEXT & ~filters.COMMAND, bot_handler.save_instagram)
               ]
           },
           fallbacks=[CommandHandler('start', bot_handler.start)]
       )

       # –î–æ–¥–∞–≤–∞–Ω–Ω—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤
       print("–î–æ–¥–∞–≤–∞–Ω–Ω—è –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤...")
       application.add_handler(conv_handler)
       application.add_handler(CallbackQueryHandler(bot_handler.handle_callback_query))

       # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞ –∑ –æ–±—Ä–æ–±–∫–æ—é –ø–æ–º–∏–ª–æ–∫
       print("–ó–∞–ø—É—Å–∫ –±–æ—Ç–∞...")
       logger.info("Starting Web3 Dating Bot...")

       max_retries = 5
       retry_count = 0

       while retry_count < max_retries:
           try:
               print(f"–°–ø—Ä–æ–±–∞ {retry_count + 1} –∑ {max_retries} –∑–∞–ø—É—Å–∫—É –±–æ—Ç–∞")
               application.run_polling()
               break
           except (TimedOut, NetworkError) as e:
               retry_count += 1
               logger.error(f"Network error: {e}. Attempt {retry_count} of {max_retries}")
               print(f"–ü–æ–º–∏–ª–∫–∞ –º–µ—Ä–µ–∂—ñ: {e}. –°–ø—Ä–æ–±–∞ {retry_count} –∑ {max_retries}")
               time.sleep(5)  # Wait 5 seconds before retrying
   except Exception as e:
       print(f"–ö—Ä–∏—Ç–∏—á–Ω–∞ –ø–æ–º–∏–ª–∫–∞ –≤ main(): {e}")
       import traceback
       traceback.print_exc()
   finally:
       # –ó–∞–∫—Ä–∏–≤–∞—î–º–æ MongoDB –∑'—î–¥–Ω–∞–Ω–Ω—è, —è–∫—â–æ –≤–æ–Ω–æ –≤—ñ–¥–∫—Ä–∏—Ç–µ
       if mongodb_client:
           print("–ó–∞–∫—Ä–∏—Ç—Ç—è MongoDB –∑'—î–¥–Ω–∞–Ω–Ω—è...")
           try:
               mongodb_client.close()
               print("MongoDB –∑'—î–¥–Ω–∞–Ω–Ω—è —É—Å–ø—ñ—à–Ω–æ –∑–∞–∫—Ä–∏—Ç–æ")
           except Exception as e:
               print(f"–ü–æ–º–∏–ª–∫–∞ –∑–∞–∫—Ä–∏—Ç—Ç—è MongoDB –∑'—î–¥–Ω–∞–Ω–Ω—è: {e}")

if __name__ == "__main__":
   try:
       print("–ü–æ—á–∏–Ω–∞—î–º–æ –∑–∞–ø—É—Å–∫ –ø—Ä–æ–≥—Ä–∞–º–∏...")
       main()
   except Exception as e:
       print(f"–ö–†–ò–¢–ò–ß–ù–ê –ü–û–ú–ò–õ–ö–ê: {str(e)}")
       import traceback
       traceback.print_exc()
